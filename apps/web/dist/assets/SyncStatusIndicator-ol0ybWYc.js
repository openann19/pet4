const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/view-ChatView.tsx-DI-Ea8ls.js","assets/react-vendor-atdIga2R.js","assets/vendor-B2U5onNE.js","assets/utils-vendor-7mYxNw04.js","assets/ui-vendor-CttiZxwU.js","assets/feature-admin-g8AIjMAb.js","assets/feature-adoption-C919WvgL.js","assets/feature-community-DxZ7YsOF.js","assets/feature-chat-CPR2_-OR.js","assets/view-AdoptionView.tsx-BJlxubb2.js","assets/matching-api-CTzLtKCQ.js","assets/image-upload-api-CzEps4bQ.js"])))=>i.map(i=>d[i]);
var e=Object.defineProperty,t=(t,i,n)=>((t,i,n)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[i]=n)(t,"symbol"!=typeof i?i+"":i,n);import{r as i,j as n,cR as s,aQ as a,an as r,cS as c}from"./react-vendor-atdIga2R.js";import{f as o,aa as l,ab as d,ac as u,al as h,_ as g,N as y,U as m,V as f,W as p,Q as w,d as S,A as x,ap as A}from"./feature-admin-g8AIjMAb.js";import{P as _,e as v,h as I}from"./feature-chat-CPR2_-OR.js";import"./vendor-B2U5onNE.js";import"./utils-vendor-7mYxNw04.js";import"./ui-vendor-CttiZxwU.js";import"./feature-adoption-C919WvgL.js";import"./feature-community-DxZ7YsOF.js";const E=o("offline-sync");class j{constructor(){t(this,"isOnline",navigator.onLine),t(this,"isSyncing",!1),t(this,"syncQueue",[]),t(this,"listeners",new Set),t(this,"onlineHandler",null),t(this,"offlineHandler",null),t(this,"lastSyncTime"),t(this,"syncProgress",null),t(this,"enableIncrementalSync",!0),t(this,"enablePrioritizedSync",!0),t(this,"enableBackgroundSync",!0),t(this,"idleSyncTimeout",null),this.initializeEventListeners(),this.loadQueueFromStorage()}initializeEventListeners(){if("undefined"!=typeof window){this.onlineHandler=()=>{try{E.info("Online - starting sync"),this.isOnline=!0,this.notifyListeners(),this.loadLastSyncTime(),this.syncPendingActions()}catch(e){const t=e instanceof Error?e:new Error(String(e));E.error("OfflineSyncManager online handler error",t)}},this.offlineHandler=()=>{try{E.info("Offline - queuing future actions"),this.isOnline=!1,this.notifyListeners()}catch(e){const t=e instanceof Error?e:new Error(String(e));E.error("OfflineSyncManager offline handler error",t)}};try{window.addEventListener("online",this.onlineHandler),window.addEventListener("offline",this.offlineHandler)}catch(e){const t=e instanceof Error?e:new Error(String(e));E.error("OfflineSyncManager setup event listeners error",t)}}}destroy(){if("undefined"!=typeof window){try{this.onlineHandler&&(window.removeEventListener("online",this.onlineHandler),this.onlineHandler=null),this.offlineHandler&&(window.removeEventListener("offline",this.offlineHandler),this.offlineHandler=null),null!==this.idleSyncTimeout&&(clearTimeout(this.idleSyncTimeout),this.idleSyncTimeout=null)}catch(e){const t=e instanceof Error?e:new Error(String(e));E.error("OfflineSyncManager cleanup event listeners error",t)}this.listeners.clear(),this.syncQueue=[]}}async loadQueueFromStorage(){try{try{const e=await l.get(d.SYNC.QUEUE);if(e.data&&Array.isArray(e.data))return this.syncQueue=e.data,E.info("Loaded pending actions from API",{count:this.syncQueue.length}),void(this.isOnline&&this.syncQueue.length>0&&this.syncPendingActions())}catch(e){E.warn("Failed to load queue from API, falling back to local storage",{error:e})}const t=await u.get("offline-sync-queue");t&&Array.isArray(t)&&(this.syncQueue=t,E.info("Loaded pending actions from storage",{count:this.syncQueue.length}),this.isOnline&&this.syncQueue.length>0&&this.syncPendingActions())}catch(t){E.error("Failed to load queue from storage",t instanceof Error?t:new Error(String(t)))}}async saveQueueToStorage(){try{try{await l.post(d.SYNC.QUEUE,{queue:this.syncQueue}),E.debug("Saved queue to API",{count:this.syncQueue.length})}catch(e){E.warn("Failed to save queue to API, saving locally",{error:e})}await u.set("offline-sync-queue",this.syncQueue)}catch(t){E.error("Failed to save queue to storage",t instanceof Error?t:new Error(String(t)))}}async queueAction(e,t){const i={id:h(),action:e,data:t,timestamp:(new Date).toISOString(),retries:0,maxRetries:3,correlationId:h(),status:"pending"};return this.syncQueue.push(i),await this.saveQueueToStorage(),this.notifyListeners(),E.debug("Queued action",{action:e,actionId:i.id}),this.isOnline?this.syncPendingActions():this.scheduleBackgroundSync(),i.id}async syncPendingActions(){if(this.isSyncing||!this.isOnline||0===this.syncQueue.length)return;this.isSyncing=!0,this.notifyListeners(),E.info("Starting sync",{actionCount:this.syncQueue.length});let e=this.syncQueue.filter(e=>"pending"===e.status||"failed"===e.status);this.enablePrioritizedSync&&(e=this.prioritizeActions(e)),this.enableIncrementalSync&&this.lastSyncTime&&(e=this.filterIncrementalActions(e));const t=e.length;let i=0,n=0;this.syncProgress={total:t,completed:0,failed:0,percentage:0};for(const c of e){if(!this.isOnline){E.info("Went offline during sync, pausing");break}try{c.status="syncing",this.syncProgress={total:t,completed:i,failed:n,percentage:Math.round(i/t*100),currentAction:c.action},this.notifyListeners(),await this.executeAction(c),c.status="completed",i++,E.debug("Completed action",{action:c.action,actionId:c.id}),this.syncQueue=this.syncQueue.filter(e=>e.id!==c.id)}catch(a){c.retries++,n++,c.retries>=c.maxRetries?(c.status="failed",c.error=a instanceof Error?a.message:"Unknown error",E.error("Action failed after max retries",a instanceof Error?a:new Error(String(a)),{action:c.action,actionId:c.id})):(c.status="pending",E.warn("Action failed, will retry",{action:c.action,actionId:c.id,retries:c.retries,maxRetries:c.maxRetries}))}this.syncProgress={total:t,completed:i,failed:n,percentage:Math.round(i/t*100)},this.notifyListeners()}await this.saveQueueToStorage(),this.isSyncing=!1,this.syncProgress=null,this.notifyListeners();try{const e=(new Date).toISOString();await l.post(d.SYNC.LAST_SYNC_TIME,{timestamp:e}),this.lastSyncTime=e}catch(r){E.warn("Failed to update sync time on API, saving locally",{error:r})}const s=(new Date).toISOString();await u.set("last-sync-time",s),this.lastSyncTime=s,E.info("Sync completed",{remaining:this.syncQueue.length,completed:i,failed:n})}prioritizeActions(e){const t={send_message:0,like_pet:1,pass_pet:2,create_pet:3,update_pet:4,create_story:5,react_to_message:6,update_profile:7,upload_photo:8};return[...e].sort((e,i)=>(t[e.action]??999)-(t[i.action]??999))}filterIncrementalActions(e){if(!this.lastSyncTime)return e;const t=new Date(this.lastSyncTime).getTime();return e.filter(e=>new Date(e.timestamp).getTime()>t)}scheduleBackgroundSync(){this.enableBackgroundSync&&(null!==this.idleSyncTimeout&&(clearTimeout(this.idleSyncTimeout),this.idleSyncTimeout=null),this.idleSyncTimeout=window.setTimeout(()=>{this.isOnline&&!this.isSyncing&&this.syncQueue.length>0&&(E.debug("Background sync triggered"),this.syncPendingActions()),this.idleSyncTimeout=null},5e3))}async loadLastSyncTime(){try{const e=await this.getLastSyncTime();e&&(this.lastSyncTime=e)}catch(e){E.warn("Failed to load last sync time",{error:e instanceof Error?e:new Error(String(e))})}}async executeAction(e){switch(e.action){case"send_message":{E.debug("Executing: send_message",{actionId:e.id});const{chatApi:t}=await g(async()=>{const{chatApi:e}=await import("./view-ChatView.tsx-DI-Ea8ls.js").then(e=>e.f);return{chatApi:e}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])),i=e.data;await t.sendMessage(i.matchId,{type:"text",content:i.message});break}case"like_pet":{E.debug("Executing: like_pet",{actionId:e.id});const{matchingAPI:t}=await g(async()=>{const{matchingAPI:e}=await import("./matching-api-CTzLtKCQ.js");return{matchingAPI:e}},__vite__mapDeps([10,5,1,2,3,4,6,7,0,8,9])),i=e.data;await t.swipe({petId:i.petId,targetPetId:i.targetPetId,action:"like"});break}case"pass_pet":{E.debug("Executing: pass_pet",{actionId:e.id});const{matchingAPI:t}=await g(async()=>{const{matchingAPI:e}=await import("./matching-api-CTzLtKCQ.js");return{matchingAPI:e}},__vite__mapDeps([10,5,1,2,3,4,6,7,0,8,9])),i=e.data;await t.swipe({petId:i.petId,targetPetId:i.targetPetId,action:"pass"});break}case"create_story":E.debug("Executing: create_story",{actionId:e.id}),E.warn("Story creation API not implemented, storing locally",{actionId:e.id});break;case"create_pet":{E.debug("Executing: create_pet",{actionId:e.id});const{petAPI:t}=await g(async()=>{const{petAPI:e}=await import("./view-ChatView.tsx-DI-Ea8ls.js").then(e=>e.e);return{petAPI:e}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]));await t.create(e.data);break}case"update_pet":{E.debug("Executing: update_pet",{actionId:e.id});const{petAPI:t}=await g(async()=>{const{petAPI:e}=await import("./view-ChatView.tsx-DI-Ea8ls.js").then(e=>e.e);return{petAPI:e}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])),i=e.data;await t.update(i.id,i.updates);break}case"react_to_message":{E.debug("Executing: react_to_message",{actionId:e.id});const{chatApi:t}=await g(async()=>{const{chatApi:e}=await import("./view-ChatView.tsx-DI-Ea8ls.js").then(e=>e.f);return{chatApi:e}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])),i=e.data;await t.addReaction(i.messageId,{reaction:i.reaction});break}case"update_profile":E.debug("Executing: update_profile",{actionId:e.id}),E.warn("Profile update API not implemented, storing locally",{actionId:e.id});break;case"upload_photo":{E.debug("Executing: upload_photo",{actionId:e.id});const{imageUploadApi:t}=await g(async()=>{const{imageUploadApi:e}=await import("./image-upload-api-CzEps4bQ.js");return{imageUploadApi:e}},__vite__mapDeps([11,5,1,2,3,4,6,7])),i=e.data;await t.uploadImage(i.key,i.contentType,i.arrayBuffer);break}default:throw new Error(`Unknown action type: ${e.action}`)}}getStatus(){var e,t;const i=this.syncQueue.filter(e=>"failed"===e.status).length;return{isOnline:this.isOnline,isSyncing:this.isSyncing,pendingActions:this.syncQueue.length,failedActions:i,lastSyncTime:this.lastSyncTime,progress:null==(e=this.syncProgress)?void 0:e.percentage,currentAction:null==(t=this.syncProgress)?void 0:t.currentAction}}getProgress(){return this.syncProgress}async getLastSyncTime(){var e;try{const t=await l.get(d.SYNC.LAST_SYNC_TIME);if(null==(e=t.data)?void 0:e.timestamp)return t.data.timestamp}catch(t){E.warn("Failed to get sync time from API, using local storage",{error:t})}return await u.get("last-sync-time")}subscribe(e){return this.listeners.add(e),()=>{this.listeners.delete(e)}}notifyListeners(){const e=this.getStatus();this.listeners.forEach(t=>{try{t(e)}catch(i){E.error("Error in listener",i instanceof Error?i:new Error(String(i)))}})}async retryFailedActions(){this.syncQueue.filter(e=>"failed"===e.status).forEach(e=>{e.status="pending",e.retries=0,delete e.error}),await this.saveQueueToStorage(),this.notifyListeners(),this.isOnline&&this.syncPendingActions()}async clearFailedActions(){this.syncQueue=this.syncQueue.filter(e=>"failed"!==e.status),await this.saveQueueToStorage(),this.notifyListeners()}async clearAllActions(){this.syncQueue=[],await this.saveQueueToStorage(),this.notifyListeners()}getPendingActions(){return[...this.syncQueue]}getFailedActions(){return this.syncQueue.filter(e=>"failed"===e.status)}}let b=null;function P(e){return(b||(b=new j),b).subscribe(e)}function T(){const[e,t]=i.useState({isOnline:navigator.onLine,isSyncing:!1,pendingActions:0,failedActions:0}),[o,l]=i.useState(!1),d=y(1),u=y(0),h=m(()=>({transform:[{scale:d.value},{rotate:`${u.value}deg`}]}));i.useEffect(()=>{e.isSyncing?(d.value=f(p(w(1.1),w(1))),u.value=f(p(w(10),w(-10),w(0)))):(d.value=1,u.value=0)},[e.isSyncing,d,u]),i.useEffect(()=>P(e=>{t(e)}),[]);return!e.isOnline||e.isSyncing||e.pendingActions>0||e.failedActions>0?n.jsxs(_,{open:o,onOpenChange:l,children:[n.jsx(v,{asChild:!0,children:n.jsxs(S,{variant:"ghost",size:"sm",className:"h-9 px-3 gap-2 hover:bg-primary/10 active:bg-primary/20 transition-colors",children:[n.jsx(x,{style:h,children:e.isOnline?e.isSyncing?n.jsx(a,{size:18,weight:"fill",className:"text-primary animate-pulse"}):e.failedActions>0?n.jsx(r,{size:18,weight:"fill",className:"text-amber-500"}):e.pendingActions>0?n.jsx(a,{size:18,weight:"fill",className:"text-primary"}):n.jsx(c,{size:18,weight:"fill",className:"text-green-500"}):n.jsx(s,{size:18,weight:"fill",className:"text-destructive"})}),n.jsx("span",{className:"text-xs font-medium",children:e.isOnline?e.isSyncing?"Syncing...":e.failedActions>0?`${e.failedActions} failed`:e.pendingActions>0?`${e.pendingActions} pending`:"Synced":"Offline"})]})}),n.jsx(I,{className:"w-80",align:"end",children:n.jsxs("div",{className:"space-y-3",children:[n.jsxs("div",{children:[n.jsx("h4",{className:"font-semibold text-sm mb-1",children:"Sync Status"}),n.jsx("p",{className:"text-xs text-muted-foreground",children:"Your data syncs automatically when online"})]}),n.jsxs("div",{className:"space-y-2",children:[n.jsxs("div",{className:"flex items-center justify-between text-sm",children:[n.jsx("span",{className:"text-muted-foreground",children:"Connection"}),n.jsx("span",{className:"font-medium "+(e.isOnline?"text-green-600":"text-destructive"),children:e.isOnline?"Online":"Offline"})]}),e.pendingActions>0&&n.jsxs("div",{className:"flex items-center justify-between text-sm",children:[n.jsx("span",{className:"text-muted-foreground",children:"Pending actions"}),n.jsx("span",{className:"font-medium text-primary",children:e.pendingActions})]}),e.failedActions>0&&n.jsxs("div",{className:"flex items-center justify-between text-sm",children:[n.jsx("span",{className:"text-muted-foreground",children:"Failed actions"}),n.jsx("span",{className:"font-medium text-destructive",children:e.failedActions})]}),e.lastSyncTime&&n.jsxs("div",{className:"flex items-center justify-between text-sm",children:[n.jsx("span",{className:"text-muted-foreground",children:"Last sync"}),n.jsx("span",{className:"font-medium",children:new Date(e.lastSyncTime).toLocaleTimeString()})]})]}),!e.isOnline&&n.jsx("div",{className:"bg-muted p-3 rounded-lg",children:n.jsx("p",{className:"text-xs text-muted-foreground",children:"You're currently offline. Your actions will be saved and synced automatically when you're back online."})}),e.failedActions>0&&n.jsxs("div",{className:"bg-destructive/10 p-3 rounded-lg",children:[n.jsx("p",{className:"text-xs text-destructive mb-2",children:"Some actions couldn't be synced. They'll retry automatically."}),n.jsx(S,{size:"sm",variant:"outline",className:"w-full",onClick:()=>{A.info("Retry failed actions",{action:"retryFailedActions",failedActions:e.failedActions}),l(!1)},children:"Retry Now"})]})]})})]}):null}export{T as SyncStatusIndicator};
