import{r as t,j as e}from"./react-vendor-atdIga2R.js";import{_ as a,f as i,N as n,U as r,A as o,b4 as s}from"./feature-admin-g8AIjMAb.js";import{d as c,u as l,o as d,n as h,m as u,e as p,s as f}from"./utils-vendor-7mYxNw04.js";import{Gesture as g,GestureDetector as m}from"./_react-native-gesture-handler-stub-B1_bHZPA.js";import"./vendor-B2U5onNE.js";import"./ui-vendor-CttiZxwU.js";import"./feature-adoption-C919WvgL.js";import"./feature-community-DxZ7YsOF.js";const y=c(l([d({type:u("resize"),width:h().int().positive(),height:h().int().positive()}),d({type:u("crop"),x:h().nonnegative(),y:h().nonnegative(),width:h().positive(),height:h().positive()}),d({type:u("rotate"),degrees:h()}),d({type:u("flip"),axis:p(["horizontal","vertical"])}),d({type:u("adjust"),brightness:h().optional(),contrast:h().optional(),saturation:h().optional(),temperature:h().optional(),exposure:h().optional()}),d({type:u("blur"),radius:h().nonnegative()}),d({type:u("filter"),name:p(["none","mono","sepia","vivid","cool","warm","cinematic"]),intensity:h().min(0).max(1).optional()}),d({type:u("watermark"),uri:f().url(),x:h(),y:h(),scale:h().optional(),opacity:h().min(0).max(1).optional()})]));c(l([d({type:u("trim"),startSec:h().min(0),endSec:h().min(0)}),d({type:u("resize"),width:h().int().positive(),height:h().int().positive()}),d({type:u("rotate"),degrees:h()}),d({type:u("flip"),axis:p(["horizontal","vertical"])}),d({type:u("speed"),rate:h().min(.25).max(4)}),d({type:u("adjust"),brightness:h().optional(),contrast:h().optional(),saturation:h().optional(),temperature:h().optional(),exposure:h().optional()}),d({type:u("filter"),name:p(["none","mono","sepia","vivid","cool","warm","cinematic"]),intensity:h().min(0).max(1).optional()}),d({type:u("watermark"),uri:f().url(),x:h(),y:h(),scale:h().optional(),opacity:h().min(0).max(1).optional()})]));const w=i("ImageEngine");function v(){return"undefined"!=typeof window}const x={none:()=>[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],mono:t=>{const e=.299*(1-t)+.299*t,a=.587*(1-t)+.587*t,i=.114*(1-t)+.114*t;return[e,a,i,0,0,e,a,i,0,0,e,a,i,0,0,0,0,0,1,0]},sepia:t=>[.393*(1-t)+.393*t,.769*(1-t)+.769*t,.189*(1-t)+.189*t,0,0,.349*(1-t)+.349*t,.686*(1-t)+.686*t,.168*(1-t)+.168*t,0,0,.272*(1-t)+.272*t,.534*(1-t)+.534*t,.131*(1-t)+.131*t,0,0,0,0,0,1,0],cool:t=>{const e=.15*t;return[1-e,0,0,0,0,0,1,0,0,0,0,0,1+e,0,0,0,0,0,1,0]},warm:t=>{const e=.15*t;return[1+e,0,0,0,0,0,1-e,0,0,0,0,0,1-e,0,0,0,0,0,1,0]},vivid:t=>{const e=1+.35*t;return[.299*e,.587*e,.114*e,0,0,.299*(1-e),.587*(1-e)+e,.114*(1-e),0,0,.299*(1-e),.587*(1-e),.114*(1-e)+e,0,0,0,0,0,1,0]},cinematic:t=>{const e=1+.15*t,a=1+.05*t;return[e*(1+.08*t)*a,0,0,0,0,0,e*(1+.25*t)*a,0,0,0,0,0,e*a,0,0,0,0,0,1,0]}};async function b(t){if(t.startsWith("http")||t.startsWith("https")){const e=await fetch(t);if(!e.ok)throw new Error(`Failed to fetch image: ${e.statusText}`);const a=await e.arrayBuffer();return new Uint8Array(a)}if(v()&&t.startsWith("data:")){const e=t.split(",")[1];if(!e)throw new Error("Invalid data URI format");const a=atob(e),i=new Uint8Array(a.length);for(let t=0;t<a.length;t++)i[t]=a.charCodeAt(t);return i}if(!v()){const e=await a(()=>import("./_expo-file-system-stub-CwJCtlEO.js"),[]),i=await e.default.readAsStringAsync(t,{encoding:"base64"}),n=atob(i),r=new Uint8Array(n.length);for(let t=0;t<n.length;t++)r[t]=n.charCodeAt(t);return r}throw new Error(`Unsupported URI scheme: ${t}`)}async function A(t,e,i={}){return async function(t,e,i={}){try{let n=function(t){return"object"==typeof t&&null!==t&&"clear"in t&&"drawImageRect"in t&&"function"==typeof t.clear};y.parse(e);const{Skia:r}=await a(async()=>{const{Skia:t}=await import("./_react-native-skia-stub-BdB_wZSH.js");return{Skia:t}},[]),o=await b(t.uri),s=r.Data.fromBytes(o),c=r.Image.MakeImageFromEncoded(s);if(!c)throw new Error("Unable to decode image from provided URI");let l=t.width??c.width(),d=t.height??c.height(),h=c;const u=(t,e=l,a=d)=>{const i=r.Surface.MakeOffscreen(e,a);if(!i)throw new Error("Failed to create offscreen surface");const o=i.getCanvas();if(!o||!n(o))throw new Error("Failed to get canvas from surface");t(o);const s=i.makeImageSnapshot();if(!s)throw new Error("Failed to create image snapshot");l=e,d=a,h=s};for(const t of e)switch(t.type){case"resize":{const e=Math.max(1,Math.round(t.width)),a=Math.max(1,Math.round(t.height));u(t=>{const i=r.Color("black");t.clear(i);const n=r.Paint();t.drawImageRect(h,{x:0,y:0,width:h.width(),height:h.height()},{x:0,y:0,width:e,height:a},n)},e,a);break}case"crop":{const e=Math.max(0,Math.min(t.x,l-1)),a=Math.max(0,Math.min(t.y,d-1)),i=Math.min(t.width,l-e),n=Math.min(t.height,d-a);u(t=>{const o=r.Paint();t.drawImageRect(h,{x:e,y:a,width:i,height:n},{x:0,y:0,width:i,height:n},o)},i,n);break}case"rotate":{const e=(t.degrees%360+360)%360*Math.PI/180,a=Math.abs(Math.cos(e)),i=Math.abs(Math.sin(e)),n=Math.round(l*a+d*i),o=Math.round(l*i+d*a);u(t=>{const a=r.Color("black");t.clear(a),t.translate(n/2,o/2),t.rotate(e),t.translate(-l/2,-d/2);const i=r.Paint();t.drawImage(h,0,0,i)},n,o);break}case"flip":u(e=>{e.save();const a="horizontal"===t.axis?-1:1,i="vertical"===t.axis?-1:1;e.scale(a,i);const n="horizontal"===t.axis?-l:0,r="vertical"===t.axis?-d:0;e.drawImage(h,n,r),e.restore()});break;case"adjust":{const e=t.brightness??0,a=t.contrast??0,i=t.saturation??0,n=t.temperature??0,o=t.exposure??0,s=[1+a+e+o,0,0,0,0,0,1+a+i+e+o,0,0,0,0,0,1+a+e+o,0,0,0,0,0,1,0];if(0!==n){const t=s[0]??0,e=s[10]??0;s[0]=t+.1*n,s[10]=e-.1*n}u(t=>{const e=r.Paint(),a=r.ColorFilter.MakeMatrix(s);e.setColorFilter(a),t.drawImage(h,0,0,e)});break}case"blur":{const e=Math.max(0,t.radius);u(t=>{const a=r.Paint(),i=r.ImageFilter.MakeBlur(e,e,0);a.setImageFilter(i),t.drawImage(h,0,0,a)});break}case"filter":{const e=t.intensity??1,a=x[t.name](e);u(t=>{const e=r.Paint(),i=r.ColorFilter.MakeMatrix(a);e.setColorFilter(i),t.drawImage(h,0,0,e)});break}case"watermark":{const e=await b(t.uri),a=r.Data.fromBytes(e),i=r.Image.MakeImageFromEncoded(a);if(!i)throw new Error("Failed to decode watermark image");const n=t.scale??1,o=Math.round(i.width()*n),s=Math.round(i.height()*n);u(e=>{const a=r.Paint();void 0!==t.opacity&&a.setAlphaf(t.opacity),e.drawImageRect(i,{x:0,y:0,width:i.width(),height:i.height()},{x:t.x,y:t.y,width:o,height:s},a),e.drawImage(h,0,0)});break}}const p="png"===(i.imageFormat??"jpeg"),f=Math.round(100*(i.quality??.9)),g=p?1:0,m=h.encodeToBase64(g,f);if(!m)throw new Error("Failed to encode output image");if(v())return{type:"image",uri:`data:${p?"image/png":"image/jpeg"};base64,${m}`,width:l,height:d};const w=await a(()=>import("./_expo-file-system-stub-CwJCtlEO.js"),[]),A=w.default??w.FileSystem??w,I=p?"png":"jpg",k="cacheDirectory"in A&&A.cacheDirectory?A.cacheDirectory:null;if(!k)throw new Error("File system cache directory not available");const j=`${k}edit-${Date.now()}.${I}`;if("writeAsStringAsync"in A&&"function"==typeof A.writeAsStringAsync)await A.writeAsStringAsync(j,m,{encoding:"base64"});else if("default"in A&&A.default&&"writeAsStringAsync"in A.default)await A.default.writeAsStringAsync(j,m,{encoding:"base64"});else{if(!("writeAsStringAsync"in w)||"function"!=typeof w.writeAsStringAsync)throw new Error("writeAsStringAsync not available in FileSystem module");await w.writeAsStringAsync(j,m,{encoding:"base64"})}let M;if("getInfoAsync"in A&&"function"==typeof A.getInfoAsync)M=await A.getInfoAsync(j);else if("default"in A&&A.default&&"getInfoAsync"in A.default)M=await A.default.getInfoAsync(j);else{if(!("getInfoAsync"in w)||"function"!=typeof w.getInfoAsync)throw new Error("getInfoAsync not available in FileSystem module");M=await w.getInfoAsync(j)}return{type:"image",uri:j,width:l,height:d,...void 0!==M.size&&{bytes:M.size}}}catch(n){const a=n instanceof Error?n:new Error(String(n));throw w.error("Image pipeline failed",a,{inputUri:t.uri,operationCount:e.length}),a}}(t,e,i)}const I=i("MediaEditor"),k=["none","mono","sepia","vivid","cool","warm","cinematic"],j="undefined"!=typeof window;function M({source:a,onDone:i,onCancel:s}){const c=n(1),l=n(0),d=n(0),[h,u]=t.useState("none"),[p,f]=t.useState(!1),y=t.useMemo(()=>g.Simultaneous(g.Pan().onChange(t=>{l.value+=t.changeX,d.value+=t.changeY}),g.Pinch().onChange(t=>{c.value*=t.scaleChange})),[c,l,d]),w=r(()=>({transform:[{translateX:l.value},{translateY:d.value},{scale:c.value}]})),v=t.useCallback(async()=>{if(!p){f(!0);try{const t=[{type:"filter",name:h,intensity:1},{type:"adjust",contrast:.1}],e={type:"image",uri:a.uri};void 0!==a.width&&(e.width=a.width),void 0!==a.height&&(e.height=a.height);const n=await A(e,t);i(n.uri)}catch(t){const e=t instanceof Error?t:new Error(String(t));throw I.error("Export failed",e,{sourceUri:a.uri}),e}finally{f(!1)}}},[h,a,i,p]),x=t.useCallback(()=>{null==s||s()},[s]);return e.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",backgroundColor:"#000"},children:[e.jsx(m,{gesture:y,children:e.jsx(o,{style:w,children:j?e.jsx("img",{src:a.uri,alt:"Media preview",style:{width:"100%",height:"100%",objectFit:"contain"}}):e.jsx("div",{style:{width:"100%",height:"100%",backgroundColor:"#000"}})})}),e.jsxs("div",{style:{padding:12,backgroundColor:"#111",display:"flex",flexDirection:"row",gap:8,alignItems:"center",flexWrap:"wrap"},children:[k.map(t=>e.jsx(S,{active:t===h,onPress:()=>u(t),label:t},t)),e.jsxs("div",{style:{marginLeft:"auto",display:"flex",flexDirection:"row",gap:8},children:[void 0!==s&&e.jsx(E,{onPress:x,label:"Cancel",variant:"secondary"}),e.jsx(E,{onPress:v,label:p?"Processing...":"Save",variant:"primary",disabled:p})]})]})]})}function S({active:t,onPress:a,label:i}){return e.jsx(o,{onClick:a,style:{paddingHorizontal:10,paddingVertical:6,borderRadius:999,backgroundColor:t?"#08f":"#222",cursor:"pointer"},children:e.jsx(s.Text,{style:{color:t?"#fff":"#aaa",fontSize:12,fontWeight:t?"600":"400"},children:i})})}function E({onPress:t,label:a,variant:i="primary",disabled:n=!1}){const r="primary"!==i||n?"#fff":"#000",c=n?void 0:t,l={paddingHorizontal:14,paddingVertical:8,borderRadius:12,backgroundColor:n?"#666":"primary"===i?"#0af":"#444",cursor:n?"not-allowed":"pointer",opacity:n?.5:1};return void 0!==c&&(l.onClick=c),e.jsx(o,{...void 0!==c?{onClick:c}:{},style:l,children:e.jsx(s.Text,{style:{color:r,fontWeight:"600",fontSize:14},children:a})})}export{M as MediaEditor};
