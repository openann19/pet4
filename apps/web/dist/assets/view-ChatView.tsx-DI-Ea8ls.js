var e=Object.defineProperty,t=(t,a,s)=>((t,a,s)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[a]=s)(t,"symbol"!=typeof a?a+"":a,s);import{r as a,j as s,bG as r,bH as n,bK as i,bL as o,bc as l,aA as c,bM as d,bN as u,bD as m,bC as h,am as p,a7 as g,bO as f,at as x,ap as y,bP as v,bQ as w,bR as b,bS as j,Y as N,bv as I,bh as S,bi as E,a3 as C,aF as A,W as k,bT as P,bF as M,b7 as R}from"./react-vendor-atdIga2R.js";import{f as T,am as _,ap as D,h as O,N as U,Q as F,U as L,A as $,d as z,V,W as q,G as W,H as Q,J as H,a2 as K,E as B,al as J,M as G,aq as Y,ar as X,_ as Z,a as ee,O as te,m as ae,ad as se,ae as re,af as ne,ag as ie,I as oe,aa as le,ab as ce,u as de,as as ue}from"./feature-admin-g8AIjMAb.js";import{f as me,g as he,a as pe,b as ge,u as fe,S as xe,c as ye,d as ve,V as we,P as be,e as je,h as Ne,R as Ie,i as Se,W as Ee,M as Ce,j as Ae,C as ke,k as Pe,l as Me}from"./feature-chat-CPR2_-OR.js";import Re from"simple-peer";import{P as Te,R as _e,S as De,T as Oe,U as Ue}from"./vendor-B2U5onNE.js";import{o as Fe,s as Le,f as $e,n as ze,d as Ve,e as qe,h as We,r as Qe}from"./utils-vendor-7mYxNw04.js";import{P as He}from"./view-AdoptionView.tsx-BJlxubb2.js";class Ke extends Error{constructor(e,a={},s){super(e),t(this,"context"),t(this,"code"),t(this,"timestamp"),this.name="FixerError",this.context=a,void 0!==s&&(this.code=s),this.timestamp=(new Date).toISOString(),Error.captureStackTrace&&Error.captureStackTrace(this,Ke)}getFormattedMessage(){const e=[];this.context.file&&e.push(`file: ${this.context.file}`),void 0!==this.context.position&&e.push(`position: ${this.context.position}`),this.context.node&&e.push(`node: ${this.context.node}`),this.context.action&&e.push(`action: ${this.context.action}`),this.code&&e.push(`code: ${this.code}`);const t=e.length>0?` (${e.join(", ")})`:"";return`${this.message}${t}`}toJSON(){return{name:this.name,message:this.message,code:this.code,context:this.context,timestamp:this.timestamp,stack:this.stack}}}const Be={async getItem(e){const t=await De(e);if("string"==typeof t)return t;if(null==t)return null;throw new TypeError(`Expected string value for key "${e}", received ${typeof t}`)},async setItem(e,t){await _e(e,t)},async removeItem(e){await Te(e)}},Je=Object.freeze(Object.defineProperty({__proto__:null,idbStorage:Be},Symbol.toStringTag,{value:"Module"})),Ge=Ue({storage:Be,key:"petspark-query-cache",serialize:JSON.stringify,deserialize:JSON.parse}),Ye=new Oe({defaultOptions:{queries:{staleTime:6e4,gcTime:18e5,retry:2,retryDelay:e=>Math.min(1e3*2**e,3e4),refetchOnWindowFocus:!0,refetchOnReconnect:!0,refetchOnMount:!1},mutations:{retry:1,retryDelay:1e3}}}),Xe={syncInterval:3e5},Ze={matches:{list:["matches"]},pets:{list:["pets","list"],detail:e=>["pets",e]},chat:{rooms:["chat","rooms"],room:e=>["chat","rooms",e],messages:e=>["chat","rooms",e,"messages"],voiceMessages:e=>["chat","rooms",e,"voice-messages"]}},et=T("WebRTCPeer");class tt{constructor(e){t(this,"peer",null),t(this,"config"),t(this,"cleanupListener",null),this.config=e}async connect(){return new Promise((e,t)=>{var a,s;try{const r=function(){const e=[];return e.push({urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}),e}();this.peer=new Re({initiator:this.config.isInitiator,trickle:!0,stream:this.config.localStream,config:{iceServers:r}}),this.peer.on("signal",e=>{this.sendSignal(e).catch(e=>{et.error("Failed to send signal",e instanceof Error?e:new Error(String(e)),{callId:this.config.callId})})}),this.peer.on("stream",e=>{et.info("Remote stream received",{callId:this.config.callId}),this.config.onRemoteStream(e)}),this.peer.on("connect",()=>{var t,a;et.info("Peer connection established",{callId:this.config.callId}),null==(a=(t=this.config).onConnectionStateChange)||a.call(t,"connected"),e()}),this.peer.on("close",()=>{var e,t;et.info("Peer connection closed",{callId:this.config.callId}),null==(t=(e=this.config).onConnectionStateChange)||t.call(e,"disconnected")}),this.peer.on("error",e=>{var a,s;et.error("Peer connection error",e,{callId:this.config.callId}),null==(s=(a=this.config).onConnectionStateChange)||s.call(a,"failed"),t(e)}),this.setupSignalingListener(),this.config.isInitiator||null==(s=(a=this.config).onConnectionStateChange)||s.call(a,"connecting")}catch(r){const e=r instanceof Error?r:new Error(String(r));et.error("Failed to create peer connection",e,{callId:this.config.callId}),t(e)}})}async sendSignal(e){const t={type:this.determineSignalType(e),from:this.config.localUserId,to:this.config.remoteUserId,callId:this.config.callId,data:e},a=await _.emitWebRTCSignal(t);if(!a.success)throw new Error(a.error??"Failed to send signal")}determineSignalType(e){if("string"==typeof e)try{const t=JSON.parse(e);if("object"==typeof t&&null!==t){const e=t;if("offer"===e.type)return"offer";if("answer"===e.type)return"answer";if(void 0!==e.candidate)return"candidate"}}catch{}return this.config.isInitiator?"offer":"answer"}setupSignalingListener(){this.cleanupListener=_.onWebRTCSignal(this.config.callId,this.config.localUserId,e=>{var t,a;if(e.from===this.config.remoteUserId&&this.peer)try{this.peer.signal(e.data),null==(a=(t=this.config).onConnectionStateChange)||a.call(t,"connecting")}catch(s){et.error("Failed to process incoming signal",s instanceof Error?s:new Error(String(s)),{callId:this.config.callId,signalType:e.type})}})}replaceStream(e){if(this.peer)try{this.peer.removeStream(this.config.localStream),this.peer.addStream(e),this.config.localStream=e}catch(t){et.error("Failed to replace stream",t instanceof Error?t:new Error(String(t)),{callId:this.config.callId})}}isConnected(){return null!==this.peer&&!this.peer.destroyed&&this.peer.connected}destroy(){if(this.cleanupListener&&(this.cleanupListener(),this.cleanupListener=null),this.peer){try{this.peer.destroy()}catch(e){et.error("Error destroying peer",e instanceof Error?e:new Error(String(e)),{callId:this.config.callId})}this.peer=null}et.info("Peer connection destroyed",{callId:this.config.callId})}}function at(e){const t=Math.floor(e/3600),a=Math.floor(e%3600/60),s=e%60;return t>0?`${t}:${a.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`:`${a}:${s.toString().padStart(2,"0")}`}function st(e="4k"){switch(e){case"4k":return{width:{ideal:3840,max:3840},height:{ideal:2160,max:2160},frameRate:{ideal:60,max:60},facingMode:"user"};case"1080p":return{width:{ideal:1920,max:1920},height:{ideal:1080,max:1080},frameRate:{ideal:60,max:60},facingMode:"user"};case"720p":return{width:{ideal:1280,max:1280},height:{ideal:720,max:720},frameRate:{ideal:30,max:30},facingMode:"user"};case"480p":return{width:{ideal:854,max:854},height:{ideal:480,max:480},frameRate:{ideal:30,max:30},facingMode:"user"}}}async function rt(e,t="4k"){try{const a={audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:48e3,channelCount:2},video:"video"===e&&st(t)};return await navigator.mediaDevices.getUserMedia(a)}catch(a){const s=a instanceof Error?a:new Error(String(a));return D.error("Failed to get media permissions",s,{type:e,videoQuality:t}),"4k"===t&&"video"===e?(D.info("4K not supported, falling back to 1080p",{type:e,fromQuality:"4k",toQuality:"1080p"}),rt(e,"1080p")):"1080p"===t&&"video"===e?(D.info("1080p not supported, falling back to 720p",{type:e,fromQuality:"1080p",toQuality:"720p"}),rt(e,"720p")):null}}function nt(e){const t=e.getVideoTracks()[0];if(!t)return"No video";const a=t.getSettings(),s=a.width||0,r=a.height||0,n=a.frameRate||0;return s>=3840&&r>=2160?`4K (${s}x${r} @ ${n}fps)`:s>=1920&&r>=1080?`1080p (${s}x${r} @ ${n}fps)`:s>=1280&&r>=720?`720p (${s}x${r} @ ${n}fps)`:`${s}x${r} @ ${n}fps`}function it(e){e&&e.getTracks().forEach(e=>e.stop())}async function ot(e){e.onStatusChange("ringing");try{const t=function(e){return new tt(e)}({callId:e.callId,localUserId:e.localUserId,remoteUserId:e.remoteUserId,isInitiator:e.isInitiator,localStream:e.localStream,onRemoteStream:e.onRemoteStream,onConnectionStateChange:t=>{"connecting"===t?e.onStatusChange("connecting"):"connected"===t?e.onStatusChange("active"):"failed"===t?e.onStatusChange("failed"):"disconnected"===t&&e.onStatusChange("ended")}});return await t.connect(),t}catch(t){const a=t instanceof Error?t:new Error(String(t));throw D.error("Failed to establish call connection",a,{action:"establishCallConnection",callId:e.callId,remoteUserId:e.remoteUserId}),e.onStatusChange("failed"),new Ke("Failed to establish call connection",{action:"establishCallConnection",callId:e.callId,remoteUserId:e.remoteUserId},"CALL_CONNECTION_ERROR")}}function lt({session:e,onEndCall:t,onToggleMute:i,onToggleVideo:o,onToggleSpeaker:l,onMinimize:c}){const[d,u]=a.useState(0),[m,h]=a.useState(!0),[p,g]=a.useState(!1),[f,x]=a.useState(Array.from({length:30},()=>.5)),y=a.useRef(null),v=a.useRef(null),w=a.useRef(null);a.useEffect(()=>{if("active"===e.call.status){const e=setInterval(()=>{u(e=>e+1)},1e3);return()=>clearInterval(e)}},[e.call.status]),a.useEffect(()=>{y.current&&e.localStream&&(y.current.srcObject=e.localStream)},[e.localStream]),a.useEffect(()=>{v.current&&e.remoteStream&&(v.current.srcObject=e.remoteStream)},[e.remoteStream]),a.useEffect(()=>{if(e.localParticipant.isMuted||"active"!==e.call.status)w.current&&cancelAnimationFrame(w.current),x(Array.from({length:30},()=>.2));else{const e=()=>{x(e=>e.map(()=>.6*Math.random()+.2)),w.current=requestAnimationFrame(e)};e()}return()=>{w.current&&cancelAnimationFrame(w.current)}},[e.localParticipant.isMuted,e.call.status]);const b=a.useCallback(()=>{O.trigger("selection"),h(e=>!e),null==l||l()},[l]),j=a.useCallback(()=>{O.trigger("selection"),i()},[i]),N=a.useCallback(()=>{O.trigger("selection"),o()},[o]),I=a.useCallback(()=>{O.trigger("heavy"),t()},[t]),S=a.useCallback(()=>{g(e=>!e)},[]),E="video"===e.call.type,C="active"===e.call.status,A=U(0),k=U(.95);a.useEffect(()=>{A.value=F(1),k.value=F(1)},[A,k]);const P=L(()=>({opacity:A.value,transform:[{scale:k.value}]}));return s.jsx($,{style:P,className:"fixed inset-0 z-50 flex items-center justify-center "+(p?"bg-black":"bg-black/90 backdrop-blur-xl p-4"),children:s.jsxs("div",{className:`relative w-full ${p?"h-full":"max-w-2xl h-[80vh]"} bg-gradient-to-br from-primary/20 via-background/95 to-accent/20 rounded-3xl overflow-hidden shadow-2xl`,children:[E&&e.remoteParticipant.isVideoEnabled?s.jsxs("div",{className:"absolute inset-0",children:[s.jsx("video",{ref:v,autoPlay:!0,playsInline:!0,className:"w-full h-full object-cover"}),s.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-black/40 via-transparent to-black/60"})]}):s.jsx(ct,{avatar:e.remoteParticipant.avatar,name:e.remoteParticipant.name,isMuted:e.remoteParticipant.isMuted,isActive:C,audioWaveform:f}),E&&e.localParticipant.isVideoEnabled&&s.jsx(mt,{videoRef:y}),s.jsx("div",{className:"absolute top-6 left-6 z-10",children:s.jsx(ht,{name:e.remoteParticipant.name,isActive:C,duration:d,callStatus:e.call.status,quality:e.call.quality,actualResolution:e.call.actualResolution})}),s.jsx("div",{className:"absolute top-6 right-6 z-10",children:E&&s.jsx(z,{onClick:S,size:"icon",variant:"ghost",className:"glass-strong backdrop-blur-2xl text-white hover:bg-white/20",children:p?s.jsx(r,{size:20}):s.jsx(n,{size:20})})}),s.jsx(pt,{isVideoCall:E,isMuted:e.localParticipant.isMuted,isVideoEnabled:e.localParticipant.isVideoEnabled,isSpeakerOn:m,onToggleMute:j,onToggleVideo:N,onEndCall:I,onToggleSpeaker:b})]})})}function ct({avatar:e,name:t,isMuted:r,isActive:n,audioWaveform:i}){const o=U(1);a.useEffect(()=>{o.value=V(q(F(1.05),F(1)))},[o]);const l=L(()=>({transform:[{scale:o.value}]}));return s.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:s.jsxs($,{style:l,className:"flex flex-col items-center",children:[s.jsxs(W,{className:"w-40 h-40 ring-4 ring-white/30 mb-6",children:[s.jsx(Q,{src:e,alt:t}),s.jsx(H,{className:"bg-gradient-to-br from-primary to-accent text-white text-5xl font-bold",children:t[0]})]}),!r&&n&&s.jsx(dt,{waveform:i})]})})}function dt({waveform:e}){return s.jsx("div",{className:"flex items-center gap-1 h-16",children:e.map((e,t)=>s.jsx(ut,{value:e},t))})}function ut({value:e}){const t=U(64*e);a.useEffect(()=>{t.value=F(64*e)},[e,t]);const r=L(()=>({height:`${t.value}px`}));return s.jsx($,{style:r,className:"w-1.5 bg-primary rounded-full"})}function mt({videoRef:e}){const t=U(0),r=U(.8);a.useEffect(()=>{t.value=F(1),r.value=F(1)},[t,r]);const n=L(()=>({opacity:t.value,transform:[{scale:r.value}]}));return s.jsx($,{style:n,className:"absolute top-6 right-6 w-40 h-28 rounded-2xl overflow-hidden shadow-2xl ring-2 ring-white/30",children:s.jsx("video",{ref:e,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover",style:{transform:"scaleX(-1)"}})})}function ht({name:e,isActive:t,duration:r,callStatus:n,quality:o,actualResolution:l}){const c=U(0),d=U(-20);a.useEffect(()=>{c.value=F(1),d.value=F(0)},[c,d]);const u=L(()=>({opacity:c.value,transform:[{translateY:d.value}]})),m=U(1),h=U(1);a.useEffect(()=>{t?(m.value=V(q(F(1.2),F(1))),h.value=V(q(F(.5),F(1)))):m.value=V(q(F(1.2),F(1)))},[t,m,h]);const p=L(()=>({transform:[{scale:m.value}],opacity:h.value}));return s.jsxs($,{style:u,className:"glass-strong rounded-2xl px-4 py-3 backdrop-blur-2xl",children:[s.jsx("h3",{className:"font-bold text-white text-lg mb-1",children:e}),s.jsx("div",{className:"flex items-center gap-2",children:t?s.jsxs(s.Fragment,{children:[s.jsx($,{style:p,className:"w-2 h-2 bg-green-500 rounded-full"}),s.jsx("span",{className:"text-sm text-white/90 font-medium",children:at(r)})]}):s.jsxs(s.Fragment,{children:[s.jsx($,{style:p,className:"w-2 h-2 bg-yellow-500 rounded-full"}),s.jsx("span",{className:"text-sm text-white/90",children:"ringing"===n?"Ringing...":"Connecting..."})]})}),s.jsxs("div",{className:"flex items-center gap-2 mt-1 flex-wrap",children:[s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx("div",{className:"w-1.5 h-1.5 rounded-full "+("excellent"===o?"bg-green-500":"good"===o?"bg-blue-500":"fair"===o?"bg-yellow-500":"bg-red-500")}),s.jsx("span",{className:"text-xs text-white/70 capitalize",children:o})]}),l&&s.jsxs(s.Fragment,{children:[s.jsx("span",{className:"text-white/40",children:"â€¢"}),s.jsxs("div",{className:"flex items-center gap-1",children:[s.jsx(i,{size:14,className:"text-white/70",weight:"fill"}),s.jsx("span",{className:"text-xs text-white/70 font-semibold",children:l})]})]})]})]})}function pt({isVideoCall:e,isMuted:t,isVideoEnabled:r,isSpeakerOn:n,onToggleMute:i,onToggleVideo:p,onEndCall:g,onToggleSpeaker:f}){const x=U(50),y=U(0);a.useEffect(()=>{x.value=F(0),y.value=F(1)},[x,y]);const v=L(()=>({transform:[{translateY:x.value}],opacity:y.value})),w=K({scale:.95,hapticFeedback:!1}),b=K({scale:.95,hapticFeedback:!1}),j=K({scale:.95,hapticFeedback:!1}),N=K({scale:.95,hapticFeedback:!1});return s.jsx("div",{className:"absolute bottom-0 left-0 right-0 p-8",children:s.jsxs($,{style:v,className:"flex items-center justify-center gap-4",children:[s.jsx($,{style:w.animatedStyle,children:s.jsx(z,{onClick:()=>{w.handlePress(),i()},size:"icon",className:"w-14 h-14 rounded-full shadow-xl "+(t?"bg-red-500 hover:bg-red-600":"glass-strong backdrop-blur-2xl hover:bg-white/20"),children:t?s.jsx(o,{size:24,weight:"fill",className:"text-white"}):s.jsx(l,{size:24,weight:"fill",className:"text-white"})})}),e&&s.jsx($,{style:b.animatedStyle,children:s.jsx(z,{onClick:()=>{b.handlePress(),p()},size:"icon",className:"w-14 h-14 rounded-full shadow-xl "+(r?"glass-strong backdrop-blur-2xl hover:bg-white/20":"bg-red-500 hover:bg-red-600"),children:r?s.jsx(c,{size:24,weight:"fill",className:"text-white"}):s.jsx(d,{size:24,weight:"fill",className:"text-white"})})}),s.jsx($,{style:j.animatedStyle,children:s.jsx(z,{onClick:()=>{j.handlePress(),g()},size:"icon",className:"w-16 h-16 rounded-full bg-red-500 hover:bg-red-600 shadow-2xl",children:s.jsx(u,{size:28,weight:"fill",className:"text-white"})})}),s.jsx($,{style:N.animatedStyle,children:s.jsx(z,{onClick:()=>{N.handlePress(),f()},size:"icon",className:"w-14 h-14 rounded-full shadow-xl "+(n?"glass-strong backdrop-blur-2xl hover:bg-white/20":"bg-yellow-500 hover:bg-yellow-600"),children:n?s.jsx(m,{size:24,weight:"fill",className:"text-white"}):s.jsx(h,{size:24,weight:"fill",className:"text-white"})})})]})})}const gt=T("useCall");function ft(e,t,s,r){const[n,i]=a.useState(null),[o,l]=a.useState(null),[c,d]=B("call-history",[]),[u="4k",m]=B("video-quality-preference","4k"),h=a.useRef(null),g=a.useRef(null),f=a.useRef(null);a.useEffect(()=>()=>{y()},[]);const x=()=>{o&&v({id:o.id,roomId:o.roomId,matchedPetName:"Unknown",matchedPetPhoto:"",type:o.type,status:"declined",timestamp:(new Date).toISOString(),duration:0}),l(null),p.info("Call declined")},y=()=>{if(n){const t=Math.floor(((new Date).getTime()-new Date(n.call.startTime||Date.now()).getTime())/1e3);v({id:n.call.id,roomId:n.call.roomId,matchedPetName:n.remoteParticipant.name,matchedPetPhoto:n.remoteParticipant.avatar||"",type:n.call.type,status:"active"===n.call.status?"ended":"missed",timestamp:(new Date).toISOString(),duration:t}),it(h.current||void 0),it(g.current||void 0),(e=f.current||void 0)&&"destroy"in e?e.destroy():e&&"close"in e&&e.close(),h.current=null,g.current=null,f.current=null}var e;i(null),p.info("Call ended")},v=e=>{d(t=>[e,...t||[]].slice(0,50))};return{activeCall:n,incomingCall:o,callHistory:c,initiateCall:async(a,n,o,l)=>{try{const c=await rt(l,u);if(!c)return void p.error("Unable to access camera/microphone");h.current=c;const d=function(e,t,a,s){return{id:`call-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,roomId:e,type:s,initiatorId:t,recipientId:a,status:"initiating",startTime:(new Date).toISOString(),duration:0,quality:"excellent"}}(e,t,a,l),m="video"===l?nt(c):void 0,x={call:{...d,videoQuality:u,...void 0!==m&&{actualResolution:m}},localParticipant:{id:t,name:s,...void 0!==r&&{avatar:r},isMuted:!1,isVideoEnabled:"video"===l},remoteParticipant:{id:a,name:n,...void 0!==o&&{avatar:o},isMuted:!1,isVideoEnabled:"video"===l},localStream:c,isMinimized:!1,videoQuality:u};i(x),m&&p.success(`Call starting with ${m}`);const y=await ot({callId:d.id,localUserId:t,remoteUserId:a,isInitiator:!0,localStream:c,onRemoteStream:e=>{g.current=e,i(t=>t?{...t,remoteStream:e}:null),p.success("Call connected!")},onStatusChange:e=>{i(t=>t?{...t,call:{...t.call,status:e}}:null)}});f.current=y}catch(c){p.error("Failed to start call"),gt.error("Failed to start call",c instanceof Error?c:new Error(String(c)))}},answerCall:async()=>{if(o)try{const e=await rt(o.type,u);if(!e)return p.error("Unable to access camera/microphone"),void x();h.current=e;const a="video"===o.type?nt(e):void 0,n={call:{...o,status:"connecting",videoQuality:u,...void 0!==a&&{actualResolution:a}},localParticipant:{id:t,name:s,...void 0!==r&&{avatar:r},isMuted:!1,isVideoEnabled:"video"===o.type},remoteParticipant:{id:o.initiatorId,name:"Pet Owner",isMuted:!1,isVideoEnabled:"video"===o.type},localStream:e,isMinimized:!1,videoQuality:u};i(n),l(null);const c=await ot({callId:o.id,localUserId:t,remoteUserId:o.initiatorId,isInitiator:!1,localStream:e,onRemoteStream:e=>{g.current=e,i(t=>t?{...t,remoteStream:e}:null),p.success("Call connected!")},onStatusChange:e=>{i(t=>t?{...t,call:{...t.call,status:e}}:null)}});f.current=c}catch(e){p.error("Failed to answer call"),gt.error("Failed to answer call",e instanceof Error?e:new Error(String(e)))}},declineCall:x,endCall:y,toggleMute:()=>{if(!n||!h.current)return;const e=h.current.getAudioTracks()[0];e&&(e.enabled=!e.enabled,i(t=>t?{...t,localParticipant:{...t.localParticipant,isMuted:!e.enabled}}:null))},toggleVideo:()=>{if(!n||!h.current)return;const e=h.current.getVideoTracks()[0];e&&(e.enabled=!e.enabled,i(t=>t?{...t,localParticipant:{...t.localParticipant,isVideoEnabled:e.enabled}}:null))},setIncomingCall:l,preferredQuality:u,setPreferredQuality:m}}const xt={};let yt={dev:{ENV:"dev",API_BASE_URL:"http://localhost:3000/api",WS_URL:"ws://localhost:3000",CDN_URL:"http://localhost:3000/cdn",MEDIA_UPLOAD_PROVIDER:"s3",AUTH_ISSUER:"pawfectmatch-dev",SENTRY_DSN:"",FEATURE_FLAGS_ENDPOINT:"http://localhost:3000/api/features",BUILD_VERSION:"1.0.0-dev",COMMIT_SHA:"local"},staging:{ENV:"staging",API_BASE_URL:"https://api-staging.pawfectmatch.app/api",WS_URL:"wss://ws-staging.pawfectmatch.app",CDN_URL:"https://cdn-staging.pawfectmatch.app",MEDIA_UPLOAD_PROVIDER:"cloudinary",AUTH_ISSUER:"pawfectmatch-staging",SENTRY_DSN:"https://sentry.io/staging",FEATURE_FLAGS_ENDPOINT:"https://api-staging.pawfectmatch.app/api/features",BUILD_VERSION:"1.0.0-rc",COMMIT_SHA:xt.VITE_COMMIT_SHA||"unknown"},prod:{ENV:"prod",API_BASE_URL:"https://api.pawfectmatch.app/api",WS_URL:"wss://ws.pawfectmatch.app",CDN_URL:"https://cdn.pawfectmatch.app",MEDIA_UPLOAD_PROVIDER:"cloudinary",AUTH_ISSUER:"pawfectmatch",SENTRY_DSN:"https://sentry.io/prod",FEATURE_FLAGS_ENDPOINT:"https://api.pawfectmatch.app/api/features",BUILD_VERSION:"1.0.0",COMMIT_SHA:xt.VITE_COMMIT_SHA||"unknown"}}[function(){const e="undefined"!=typeof window?window.location.hostname:"";return e.includes("staging")?"staging":e.includes("localhost")||e.includes("127.0.0.1")?"dev":"prod"}()];const vt={get current(){return yt}},wt=Fe({latitude:ze().min(-90).max(90),longitude:ze().min(-180).max(180),city:Le().min(1),country:Le().min(1),roundedLat:ze().optional(),roundedLng:ze().optional()}),bt=Fe({id:Le(),url:Le().url(),thumbnailUrl:Le().url(),order:ze().int().min(0),uploadedAt:Le().datetime()}),jt=Fe({id:Le(),ownerId:Le(),name:Le().min(1).max(50),species:qe(["dog","cat"]),breed:Le().min(1).max(100),age:ze().int().min(0).max(30),size:qe(["small","medium","large","extra-large"]),gender:qe(["male","female"]),photos:Ve(bt).min(1),personality:Ve(Le()).max(10),bio:Le().max(1e3),location:wt,verified:$e(),createdAt:Le().datetime(),updatedAt:Le().datetime(),status:qe(["active","hidden","banned"]),isActive:$e().optional()}),Nt=Fe({personality:ze().min(0).max(100),interests:ze().min(0).max(100),size:ze().min(0).max(100),age:ze().min(0).max(100),location:ze().min(0).max(100),overall:ze().min(0).max(100)}),It=Fe({id:Le(),petAId:Le(),petBId:Le(),compatibilityScore:ze().min(0).max(100),compatibilityBreakdown:Nt.optional(),status:qe(["active","archived"]),chatRoomId:Le(),createdAt:Le().datetime(),lastInteractionAt:Le().datetime()}),St=Fe({userId:Le(),emoji:Le(),addedAt:Le().datetime()}),Et=Fe({id:Le(),chatRoomId:Le(),senderId:Le(),content:Le().max(5e3),type:qe(["text","sticker"]),reactions:Ve(St),status:qe(["sending","sent","delivered","read"]),createdAt:Le().datetime(),deliveredAt:Le().datetime().optional(),readAt:Le().datetime().optional()}),Ct=Fe({theme:qe(["light","dark"]),language:qe(["en","bg"]),notifications:Fe({push:$e(),email:$e(),matches:$e(),messages:$e(),likes:$e()}),quietHours:Fe({start:Le(),end:Le()}).nullable()});Fe({id:Le(),email:Le().email(),displayName:Le().min(1).max(100),avatarUrl:Le().url().optional(),roles:Ve(qe(["user","moderator","admin"])),createdAt:Le().datetime(),updatedAt:Le().datetime(),status:qe(["active","suspended","banned"]),lastSeenAt:Le().datetime(),preferences:Ct}),Fe({accessToken:Le().min(1),refreshToken:Le().min(1),expiresIn:ze().int().positive()}),Fe({id:Le(),userId:Le(),type:qe(["match_created","new_message","like_received","story_viewed","verification_approved","verification_rejected","content_removed","account_warning"]),title:Le(),body:Le(),data:Qe(We()),read:$e(),createdAt:Le().datetime(),expiresAt:Le().datetime().optional()});const At=Fe({action:qe(["warn","suspend","ban","remove_content","no_action"]),notes:Le(),resolvedBy:Le()});Fe({id:Le(),reporterId:Le(),reportedEntityType:qe(["user","pet","message"]),reportedEntityId:Le(),reason:qe(["spam","inappropriate","fake","harassment","other"]),details:Le(),status:qe(["pending","investigating","resolved","dismissed"]),assignedTo:Le().optional(),resolution:At.optional(),createdAt:Le().datetime(),resolvedAt:Le().datetime().optional()});const kt=Fe({userId:Le(),viewedAt:Le().datetime()});Fe({id:Le(),petId:Le(),mediaUrl:Le().url(),mediaType:qe(["image","video"]),duration:ze().int().positive(),views:Ve(kt),expiresAt:Le().datetime(),createdAt:Le().datetime(),status:qe(["active","expired","removed"])}),Fe({id:Le(),petId:Le(),type:qe(["photo","document"]),status:qe(["pending","approved","rejected"]),submittedAt:Le().datetime(),reviewedAt:Le().datetime().optional(),reviewedBy:Le().optional(),notes:Le().optional()}),Fe({id:Le(),name:Le().min(1).max(50),species:qe(["dog","cat","other"]),breed:Le(),age:ze().int().min(0),size:qe(["small","medium","large","extra-large"]),gender:qe(["male","female"]),photos:Ve(Le().url()),description:Le(),specialNeeds:Le().optional(),goodWithKids:$e(),goodWithPets:$e(),status:qe(["available","pending","adopted"]),location:Le(),shelterId:Le(),shelterName:Le(),contactEmail:Le().email(),contactPhone:Le().optional(),createdAt:Le().datetime(),updatedAt:Le().datetime()}),Fe({id:Le(),authorId:Le(),authorName:Le(),authorAvatar:Le().url().optional(),content:Le().max(5e3),mediaUrls:Ve(Le().url()),tags:Ve(Le()).max(10),location:Fe({lat:ze(),lng:ze(),name:Le()}).optional(),reactions:Qe(ze()),commentCount:ze().int().min(0),shareCount:ze().int().min(0),viewCount:ze().int().min(0),status:qe(["active","hidden","removed"]),createdAt:Le().datetime(),updatedAt:Le().datetime()}),Fe({id:Le(),postId:Le(),authorId:Le(),authorName:Le(),authorAvatar:Le().url().optional(),content:Le().max(2e3),parentId:Le().optional(),reactions:Qe(ze()),status:qe(["active","hidden","removed"]),createdAt:Le().datetime(),updatedAt:Le().datetime()});const Pt=Fe({code:Le(),message:Le(),details:We().optional(),correlationId:Le(),timestamp:Le().datetime(),field:Le().optional(),validationErrors:Ve(Fe({field:Le(),message:Le()})).optional()}),Mt=e=>Fe({items:Ve(e),total:ze().int().min(0),page:ze().int().positive(),pageSize:ze().int().positive(),hasMore:$e(),nextCursor:Le().optional()}),Rt=Fe({candidates:Ve(Fe({pet:jt,score:ze().min(0).max(100),distance:ze().min(0)})),nextCursor:Le().optional(),totalCount:ze().int().min(0)}),Tt=Fe({recorded:$e(),isMatch:$e(),matchId:Le().optional(),chatRoomId:Le().optional()});Fe({id:Le(),petId:Le(),ownerId:Le(),status:qe(["pending_upload","processing","awaiting_review","approved","rejected","held_for_kyc"]),originalUrl:Le().url(),processedUrl:Le().url().optional(),thumbnailUrl:Le().url().optional(),variants:Ve(Fe({size:qe(["small","medium","large","original"]),url:Le().url(),width:ze().int().positive(),height:ze().int().positive(),fileSize:ze().int().positive()})),metadata:Fe({fileHash:Le(),contentFingerprint:Le(),originalFilename:Le(),mimeType:Le(),fileSize:ze().int().positive(),width:ze().int().positive(),height:ze().int().positive(),exifStripped:$e(),uploadIP:Le().optional()}),safetyCheck:Fe({isNSFW:$e(),isViolent:$e(),hasHumanFaces:$e(),humanFaceCount:ze().int().min(0),humanFaceDominance:ze().min(0).max(1),isDuplicate:$e(),duplicateOf:Le().optional(),confidence:Fe({nsfw:ze().min(0).max(1),violence:ze().min(0).max(1),animal:ze().min(0).max(1),humanFace:ze().min(0).max(1)}),breedInference:Fe({breed:Le(),confidence:ze().min(0).max(1)}).optional(),flags:Ve(Le()),scannedAt:Le().datetime()}),uploadedAt:Le().datetime(),processedAt:Le().datetime().optional(),reviewedAt:Le().datetime().optional(),approvedAt:Le().datetime().optional(),rejectedAt:Le().datetime().optional()}),Fe({id:Le(),userId:Le(),status:qe(["unverified","pending","verified","rejected","expired"]),provider:qe(["manual","stripe_identity","onfido","persona"]),providerSessionId:Le().optional(),providerDecisionId:Le().optional(),documents:Ve(Fe({id:Le(),type:qe(["id_card","passport","drivers_license","selfie"]),url:Le().url(),uploadedAt:Le().datetime(),verified:$e(),extractedData:Qe(We()).optional()})),livenessCheck:Fe({passed:$e(),confidence:ze().min(0).max(1),attemptCount:ze().int().min(0),completedAt:Le().datetime().optional()}).optional(),verificationData:Fe({fullName:Le().optional(),dateOfBirth:Le().optional(),documentNumber:Le().optional(),documentExpiry:Le().optional(),nationality:Le().optional(),verifiedFields:Ve(Le())}).optional(),createdAt:Le().datetime(),updatedAt:Le().datetime(),submittedAt:Le().datetime().optional(),verifiedAt:Le().datetime().optional(),rejectedAt:Le().datetime().optional(),expiresAt:Le().datetime().optional(),rejectReason:qe(["blurry_document","expired_document","document_mismatch","liveness_failed","unreadable","incomplete","suspicious"]).optional(),rejectReasonText:Le().optional(),retryCount:ze().int().min(0)});const _t=T("ValidatedAPIClient");class Dt extends Error{constructor(e,t,a){super(e),this.errors=t,this.correlationId=a,this.name="ValidationError"}}class Ot extends Error{constructor(e,t,a){super(e),this.error=t,this.correlationId=a,this.name="APIResponseError"}}const Ut=new class{constructor(){t(this,"baseURL"),t(this,"accessToken",null),t(this,"defaultTimeout",3e4),this.baseURL=vt.current.API_BASE_URL}setAccessToken(e){this.accessToken=e}setBaseURL(e){this.baseURL=e}async validateResponse(e,t,a,s=!1){if(s)return e;const r=await t.safeParseAsync(e);if(!r.success)throw _t.error("API validation error",{correlationId:a,errors:r.error.errors,data:e}),new Dt("API response validation failed",r.error.errors,a);return r.data}async request(e,t,a={}){const s=J(),r=`${this.baseURL}${e}`,n=a.timeout??this.defaultTimeout,i=new Headers(a.headers??void 0);i.set("Content-Type","application/json"),i.set("X-Correlation-ID",s),i.set("X-Client-Version","1.0.0"),i.set("X-Platform","undefined"!=typeof window?"web":"unknown"),this.accessToken&&i.set("Authorization",`Bearer ${this.accessToken}`);const o=new AbortController,l=setTimeout(()=>o.abort(),n);try{const e=await fetch(r,{...a,headers:i,signal:o.signal});if(clearTimeout(l),!e.ok){let t;try{t=await e.json()}catch{t={code:`HTTP_${e.status}`,message:e.statusText??"Request failed",correlationId:s,timestamp:(new Date).toISOString()}}const a=Pt.safeParse(t);if(a.success)throw new Ot(a.data.message,a.data,s);throw new Ot("API request failed",{code:"UNKNOWN_ERROR",message:"An unexpected error occurred",correlationId:s,timestamp:(new Date).toISOString(),details:t},s)}if(204===e.status)return;const n=await e.json();return await this.validateResponse(n,t,s,a.skipValidation)}catch(c){if(clearTimeout(l),c instanceof Dt||c instanceof Ot)throw c;if(c instanceof Error&&"AbortError"===c.name)throw new Ot("Request timeout",{code:"REQUEST_TIMEOUT",message:`Request timed out after ${n}ms`,correlationId:s,timestamp:(new Date).toISOString()},s);throw new Ot("Network request failed",{code:"NETWORK_ERROR",message:c instanceof Error?c.message:"Network request failed",details:c,correlationId:s,timestamp:(new Date).toISOString()},s)}}async get(e,t,a){return this.request(e,t,{...a,method:"GET"})}async post(e,t,a,s){return this.request(e,t,{...s,method:"POST",...a?{body:JSON.stringify(a)}:{}})}async patch(e,t,a,s){return this.request(e,t,{...s,method:"PATCH",body:JSON.stringify(a)})}async put(e,t,a,s){return this.request(e,t,{...s,method:"PUT",body:JSON.stringify(a)})}async delete(e,t,a){return this.request(e,t,{...a,method:"DELETE"})}},Ft={getById:async e=>Ut.get(`/api/v1/pets/${e}`,jt),create:async e=>Ut.post("/api/v1/pets",jt,e),update:async(e,t)=>Ut.patch(`/api/v1/pets/${e}`,jt,t),delete:async e=>Ut.delete(`/api/v1/pets/${e}`,Fe({success:$e()})),async list(e){const t=new URLSearchParams(e);return Ut.get(`/api/v1/pets?${t}`,Mt(jt))}},Lt={discover:async(e,t)=>Ut.post("/api/v1/matching/discover",Rt,{petId:e,filters:t}),swipe:async e=>Ut.post("/api/v1/matching/swipe",Tt,e),getMatches:async e=>Ut.get(`/api/v1/matching/matches?petId=${e}`,Ve(It)),reportPet:async e=>Ut.post("/api/v1/matching/report",Fe({success:$e(),reportId:Le()}),e)},$t={async getMessages(e,t){const a=t?`?cursor=${t}`:"";return Ut.get(`/api/v1/chat/${e}/messages${a}`,Mt(Et))},sendMessage:async(e,t)=>Ut.post(`/api/v1/chat/${e}/messages`,Et,{content:t,type:"text"}),markAsRead:async(e,t)=>Ut.patch(`/api/v1/chat/${e}/messages/${t}/read`,Fe({success:$e()}),{})},zt=Object.freeze(Object.defineProperty({__proto__:null,chatAPI:$t,matchingAPI:Lt,petAPI:Ft},Symbol.toStringTag,{value:"Module"}));function Vt({rooms:e,onSelectRoom:t,selectedRoomId:a}){return 0===e.length?s.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[60vh] text-center px-4",children:[s.jsxs(G,{initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},transition:{type:"spring",stiffness:200,damping:15},className:"w-24 h-24 rounded-full bg-linear-to-br from-primary/20 to-accent/20 flex items-center justify-center mb-6 relative",children:[s.jsx(G,{animate:{scale:[1,1.2,1]},transition:{duration:1.5,repeat:1/0},children:s.jsx(g,{size:48,className:"text-primary",weight:"fill"})}),s.jsx(G,{className:"absolute inset-0 rounded-full bg-linear-to-br from-primary/20 to-accent/20",animate:{scale:[1,1.5],opacity:[.5,0]},transition:{duration:2,repeat:1/0}})]}),s.jsx(G,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},className:"text-2xl font-bold mb-2",children:"No Conversations Yet"}),s.jsx(G,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"text-muted-foreground max-w-md",children:"Start chatting with your matches to plan playdates and get to know each other!"})]}):s.jsx("div",{className:"space-y-2 overflow-y-auto max-h-full",children:e.map((e,r)=>{var n;const i="number"==typeof e.unreadCount?e.unreadCount:"object"==typeof e.unreadCount&&e.unreadCount?Object.values(e.unreadCount).reduce((e,t)=>e+t,0):0,o=i>0;return s.jsx(G,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:.05*r,type:"spring",stiffness:300,damping:30},children:s.jsxs(G,{as:"button",onClick:()=>t(e),className:"w-full text-left p-4 rounded-2xl transition-all relative overflow-hidden "+(a===e.id?"glass-strong shadow-lg scale-[1.02] border border-primary/30":"glass-effect hover:glass-strong hover:scale-[1.01]"),whileHover:{y:-2},whileTap:{scale:.98},children:[o&&s.jsx(G,{className:"absolute inset-0 bg-linear-to-r from-primary/5 to-accent/5",animate:{opacity:[.5,.8,.5]},transition:{duration:2,repeat:1/0}}),s.jsxs("div",{className:"flex items-start gap-3 relative z-10",children:[s.jsxs("div",{className:"relative shrink-0",children:[s.jsx(G,{animate:o?{scale:[1,1.05,1]}:{},transition:{duration:2,repeat:1/0},children:s.jsxs(W,{className:"w-14 h-14 "+(o?"ring-2 ring-primary":"ring-2 ring-white/30"),children:[s.jsx(Q,{src:e.matchedPetPhoto,alt:e.matchedPetName||"Pet"}),s.jsx(H,{className:"bg-linear-to-br from-primary to-accent text-white font-bold",children:(null==(n=e.matchedPetName)?void 0:n[0])||"?"})]})}),o&&s.jsx(G,{initial:{scale:0},animate:{scale:1},className:"absolute -top-1 -right-1 min-w-[24px] h-6 rounded-full bg-linear-to-br from-accent to-primary flex items-center justify-center shadow-lg px-2",children:s.jsx(G,{className:"text-white text-xs font-bold",animate:{scale:[1,1.1,1]},transition:{duration:1,repeat:1/0},children:i>99?"99+":String(i)})})]}),s.jsxs("div",{className:"flex-1 min-w-0",children:[s.jsxs("div",{className:"flex items-center justify-between mb-1",children:[s.jsx("h3",{className:"font-semibold truncate "+(o?"text-foreground":"text-foreground/90"),children:e.matchedPetName||"Unknown Pet"}),e.lastMessage&&s.jsx("span",{className:"text-xs shrink-0 ml-2 "+(o?"text-primary font-semibold":"text-muted-foreground"),children:me(e.lastMessage.timestamp||e.lastMessage.createdAt)})]}),s.jsx("div",{className:"flex items-center gap-2",children:e.lastMessage?s.jsxs("div",{className:"flex-1 min-w-0 flex items-center gap-1",children:[e.lastMessage.status&&["sent","delivered","read"].includes(e.lastMessage.status)&&s.jsx("span",{className:"shrink-0",children:"read"===e.lastMessage.status?s.jsx(f,{size:14,weight:"bold",className:"text-primary"}):s.jsx(x,{size:14,weight:"bold",className:"text-muted-foreground"})}),s.jsx("p",{className:"text-sm truncate "+(o?"text-foreground font-medium":"text-muted-foreground"),children:"text"===e.lastMessage.type?e.lastMessage.content:"sticker"===e.lastMessage.type?`${e.lastMessage.content} Sticker`:"voice"===e.lastMessage.type?"ðŸŽ¤ Voice message":"ðŸ“· Image"})]}):s.jsx("p",{className:"text-sm text-muted-foreground italic flex-1 truncate",children:"Say hello! ðŸ‘‹"})}),e.isTyping&&s.jsxs(G,{initial:{opacity:0,y:-5},animate:{opacity:1,y:0},className:"flex items-center gap-1 mt-1",children:[s.jsx("div",{className:"flex gap-1",children:[0,1,2].map(e=>s.jsx(G,{className:"w-2 h-2 rounded-full bg-primary",animate:{scale:[1,1.5,1],opacity:[.5,1,.5]},transition:{duration:1,repeat:1/0,delay:.2*e}},e))}),s.jsx("span",{className:"text-xs text-primary",children:"typing..."})]})]})]})]})},e.id)})})}const qt=T("IncomingCallNotification");function Wt({call:e,callerName:t,callerAvatar:r,onAccept:n,onDecline:i}){const o=Y({isVisible:!0,duration:300}),l=X({duration:1500,intensity:.4,enabled:!0}),d=U(1),m=a.useCallback(()=>{try{O.success(),qt.info("Call accepted",{callId:e.id,callerName:t,callType:e.type}),n()}catch(a){const s=a instanceof Error?a:new Error(String(a));qt.error("Failed to accept call",s,{callId:e.id,callerName:t}),O.error()}},[e.id,e.type,t,n]),h=a.useCallback(()=>{try{O.heavy(),qt.info("Call declined",{callId:e.id,callerName:t,callType:e.type}),i()}catch(a){const s=a instanceof Error?a:new Error(String(a));qt.error("Failed to decline call",s,{callId:e.id,callerName:t}),O.error()}},[e.id,e.type,t,i]),p=K({scale:.98,onPress:m,hapticFeedback:!1}),g=K({scale:.98,onPress:h,hapticFeedback:!1});a.useEffect(()=>{d.value=V(q(F(1.05),F(1)))},[d]);const f=L(()=>({transform:[{scale:d.value}]})),x=a.useMemo(()=>"video"===e.type?"Incoming video call":"Incoming call",[e.type]),v=a.useMemo(()=>"video"===e.type?s.jsx(c,{size:16,weight:"fill","aria-hidden":"true"}):s.jsx(y,{size:16,weight:"fill","aria-hidden":"true"}),[e.type]);return s.jsx($,{style:o.style,className:"fixed top-4 left-1/2 -translate-x-1/2 z-50 w-full max-w-md px-4",role:"alertdialog","aria-labelledby":"incoming-call-title","aria-describedby":"incoming-call-description","aria-modal":"true",children:s.jsxs($,{style:l.animatedStyle,className:"glass-strong backdrop-blur-2xl rounded-3xl p-6 border border-white/30 shadow-2xl",children:[s.jsxs("div",{className:"flex items-center gap-4 mb-6",children:[s.jsx($,{style:f,children:s.jsxs(W,{className:"w-16 h-16 ring-4 ring-primary/30",children:[s.jsx(Q,{src:r,alt:t}),s.jsx(H,{className:"bg-gradient-to-br from-primary to-accent text-white text-2xl font-bold",children:t[0]??"?"})]})}),s.jsxs("div",{className:"flex-1",children:[s.jsx("h3",{id:"incoming-call-title",className:"font-bold text-lg text-foreground",children:t}),s.jsxs("div",{id:"incoming-call-description",className:"flex items-center gap-2 text-sm text-muted-foreground",role:"status","aria-live":"polite",children:[v,s.jsxs("span",{children:[x,"..."]})]})]})]}),s.jsxs("div",{className:"flex gap-3",role:"group","aria-label":"Call actions",children:[s.jsx($,{style:g.animatedStyle,className:"flex-1",children:s.jsxs(z,{onClick:g.handlePress,variant:"outline",className:"w-full h-12 border-2 border-red-500 text-red-500 hover:bg-red-500 hover:text-white transition-all","aria-label":"Decline call",children:[s.jsx(u,{size:20,weight:"fill",className:"mr-2","aria-hidden":"true"}),"Decline"]})}),s.jsx($,{style:p.animatedStyle,className:"flex-1",children:s.jsxs(z,{onClick:p.handlePress,className:"w-full h-12 bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 shadow-lg","aria-label":"Accept call",children:[s.jsx(y,{size:20,weight:"fill",className:"mr-2","aria-hidden":"true"}),"Accept"]})})]})]})})}const Qt=T("useOutbox");function Ht(e){const{sendFn:t,storageKey:s="chat-outbox",baseRetryDelay:r=250,maxAttempts:n=7,maxDelay:i=15e3,jitter:o=!0,onFlush:l}=e,c=v(),d=a.useRef(null),u=a.useRef(t),m=a.useRef(!1),h=a.useRef("undefined"==typeof navigator||navigator.onLine),{data:p=[]}=w({queryKey:["outbox",s],queryFn:async()=>{const e=await Be.getItem(s);if(!e)return[];try{return JSON.parse(e)}catch{return Qt.warn("Failed to parse outbox queue, resetting"),[]}},staleTime:1/0,gcTime:1/0}),g=b({mutationFn:async e=>(await Be.setItem(s,JSON.stringify(e)),e),onSuccess:e=>{c.setQueryData(["outbox",s],e)}});a.useEffect(()=>{u.current=t},[t]);const f=a.useCallback(e=>{g.mutate(e)},[g]),x=a.useCallback(async()=>{if(m.current||!h.current)return;const e=p||[];if(0===e.length)return;m.current=!0;const t=Date.now(),a=e.filter(e=>e.nextAt<=t);if(0===a.length)return m.current=!1,void y();Qt.debug("Processing outbox queue",{readyCount:a.length,totalCount:e.length});const s=await Promise.allSettled(a.map(async e=>{try{return await u.current(e.payload),Qt.debug("Successfully sent outbox item",{clientId:e.clientId}),{success:!0,clientId:e.clientId}}catch(t){const a=Math.min(e.attempt+1,n);if(a>=n)return Qt.error("Outbox item failed after max attempts",t instanceof Error?t:new Error(String(t)),{clientId:e.clientId,attempts:a}),{success:!1,clientId:e.clientId,failed:!0};const s=function(e,t,a,s){const r=Math.min(2**e*t,a);if(s){const e=.1*r*Math.random();return Math.floor(r+e)}return r}(a,r,i,o);return Qt.warn("Outbox item failed, will retry",{clientId:e.clientId,attempt:a,delay:s}),{success:!1,clientId:e.clientId,nextAttempt:a,delay:s}}})),c=e.map(e=>{const t=s.find(t=>"fulfilled"===t.status&&t.value.clientId===e.clientId);return t?t.value.success||t.value.failed?null:null!=t.value.nextAttempt&&null!=t.value.delay?{...e,attempt:t.value.nextAttempt,nextAt:Date.now()+t.value.delay}:e:e}).filter(e=>null!=e);f(c),m.current=!1,y(),a.length>0&&l&&l()},[p,r,n,i,o,l,f]),y=a.useCallback(()=>{if(null!=d.current)return;const e=p||[];if(0===e.length)return;const t=Date.now(),a=e.filter(e=>e.nextAt>t).sort((e,t)=>e.nextAt-t.nextAt)[0];if(a){const e=Math.max(a.nextAt-t,100);d.current=window.setTimeout(()=>{d.current=null,x()},e)}else d.current=window.setTimeout(()=>{d.current=null,x()},300)},[p,x]),j=a.useCallback((e,t,a)=>{const s=a??`${Date.now()}-${Math.random().toString(36).substring(2,15)}`,r=p||[],n=r.findIndex(t=>t.clientId===e||t.idempotencyKey===s);let i;i=n>=0?r.map((e,a)=>a===n?{...e,payload:t,attempt:0,nextAt:Date.now(),idempotencyKey:s}:e):[...r,{clientId:e,payload:t,attempt:0,nextAt:Date.now(),createdAt:Date.now(),idempotencyKey:s}],f(i),h.current&&y()},[p,f,y]),N=a.useCallback(()=>{f([]),null!=d.current&&(window.clearTimeout(d.current),d.current=null),m.current=!1},[f]),I=a.useCallback(async()=>{h.current&&await x()},[x]);return a.useEffect(()=>{const e=()=>{Qt.debug("Network connection restored, flushing outbox"),h.current=!0,x()},t=()=>{Qt.debug("Network connection lost, pausing outbox"),h.current=!1};if("undefined"!=typeof window)return window.addEventListener("online",e),window.addEventListener("offline",t),h.current=navigator.onLine,h.current&&p.length>0&&y(),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",t),null!=d.current&&window.clearTimeout(d.current)}},[x,y,p.length]),{enqueue:j,queue:p||[],clear:N,flush:I,isOnline:h.current}}function Kt({roomId:e,currentUserId:t,currentUserName:s,currentUserAvatar:r}){const n=v(),{data:i,...o}=j({queryKey:(l=e)?Ze.chat.messages(l):["chat","messages","null"],queryFn:async({pageParam:e})=>{if(!l)throw new Error("Chat room ID is required");return(await $t.getMessages(l,e)).items},enabled:!!l,getNextPageParam:(e,t)=>{},staleTime:3e4,gcTime:3e5});var l;const c=function(){const e=v();return b({mutationFn:({chatRoomId:e,content:t})=>$t.sendMessage(e,t),onSuccess:(t,a)=>{e.invalidateQueries({queryKey:Ze.chat.messages(a.chatRoomId)})}})}(),d=Ht({storageKey:`chat-outbox-${e}`,sendFn:async e=>{const{chatRoomId:t,content:a}=e;await $t.sendMessage(t,a)},onFlush:()=>{n.invalidateQueries({queryKey:Ze.chat.messages(e)})}}),u=a.useMemo(()=>(null==i?void 0:i.pages)?i.pages.flat().map(t=>({id:t.id,roomId:t.chatRoomId||e,senderId:t.senderId,type:t.type||"text",content:t.content,status:t.status||"sent",timestamp:t.createdAt,createdAt:t.createdAt,reactions:t.reactions||[]})):[],[i,e]),m=a.useMemo(()=>he(u||[]),[u]),h=a.useCallback((a,i="text",o)=>{if(!a.trim()&&"text"===i)return null;const l={id:pe(),roomId:e,senderId:t,senderName:s,...null!=r&&{senderAvatar:r},content:"text"===i?a.trim():a,type:i,timestamp:(new Date).toISOString(),createdAt:(new Date).toISOString(),status:"sending",reactions:[],...void 0!==o&&{metadata:o}};if(n.setQueryData(Ze.chat.messages(e),e=>e?{...e,pages:[[l,...e.pages[0]||[]]]}:{pages:[[l]],pageParams:[void 0]}),"voice"!==i){const t={chatRoomId:e,content:"sticker"===i?a:a.trim()};d.isOnline?c.mutate(t,{onError:()=>{d.enqueue(l.id,t,l.id)}}):d.enqueue(l.id,t,l.id)}return l},[e,t,s,r,n,c,d]),p=a.useCallback((a,s)=>{n.setQueryData(Ze.chat.messages(e),e=>e?{...e,pages:e.pages.map(e=>e.map(e=>{if(e.id===a){const a=ge(e.reactions);if(a.find(e=>{var a;return(null==(a=e.userIds)?void 0:a.includes(t))&&e.emoji===s})){const r=a.map(e=>e.emoji===s&&e.userIds?{...e,userIds:e.userIds.filter(e=>e!==t),count:(e.count??0)-1}:e).filter(e=>(e.count??0)>0);return{...e,reactions:r}}{const r=a.findIndex(e=>e.emoji===s);if(r>=0){const s=[...a],n=s[r];return n&&(s[r]={...n,userIds:[...n.userIds??[],t],count:(n.count??0)+1}),{...e,reactions:s}}return{...e,reactions:[...a,{emoji:s,userIds:[t],count:1}]}}}return e}))}:e)},[t,n,e]),g=a.useCallback(()=>{n.setQueryData(Ze.chat.messages(e),e=>e?{...e,pages:e.pages.map(e=>e.map(e=>e.senderId!==t&&"read"!==e.status?{...e,status:"read"}:e))}:e)},[t,n,e]),f=a.useCallback(t=>{n.setQueryData(Ze.chat.messages(e),e=>({pages:["function"==typeof t?t(u):t],pageParams:[void 0]}))},[u,n,e]);return{messages:u,messageGroups:m,sendMessage:h,addReaction:p,markAsRead:g,setMessages:f,isLoading:o.isLoading,isError:o.isError,error:o.error,outboxQueue:d.queue,isOnline:d.isOnline}}const Bt=T("ChatWindowNew");function Jt({room:e,currentUserId:t,currentUserName:r,currentUserAvatar:n,onBack:i}){var o,d,u,m,h,g;const j=fe("chat.virtualization"),{messages:T,messageGroups:D,sendMessage:B,addReaction:J,markAsRead:G,setMessages:Y}=Kt({roomId:e.id,currentUserId:t,currentUserName:r,...void 0!==n?{currentUserAvatar:n}:{}}),{voiceMessages:X,setVoiceMessage:le}=function(e){const t=v(),{data:a={},...s}=w({queryKey:Ze.chat.voiceMessages(e),queryFn:async()=>{const{idbStorage:t}=await Z(async()=>{const{idbStorage:e}=await Promise.resolve().then(()=>Je);return{idbStorage:e}},void 0),a=`voice-messages-${e}`,s=await t.getItem(a);return s?JSON.parse(s):{}},staleTime:1/0,gcTime:2592e6}),r=b({mutationFn:async({messageId:a,data:s})=>{const{idbStorage:r}=await Z(async()=>{const{idbStorage:e}=await Promise.resolve().then(()=>Je);return{idbStorage:e}},void 0),n=`voice-messages-${e}`,i={...t.getQueryData(Ze.chat.voiceMessages(e))||{},[a]:s};return await r.setItem(n,JSON.stringify(i)),i},onSuccess:a=>{t.setQueryData(Ze.chat.voiceMessages(e),a)}}),n=b({mutationFn:async a=>{const{idbStorage:s}=await Z(async()=>{const{idbStorage:e}=await Promise.resolve().then(()=>Je);return{idbStorage:e}},void 0),r=`voice-messages-${e}`,n=t.getQueryData(Ze.chat.voiceMessages(e))||{},{[a]:i,...o}=n;return await s.setItem(r,JSON.stringify(o)),o},onSuccess:a=>{t.setQueryData(Ze.chat.voiceMessages(e),a)}});return{voiceMessages:a,setVoiceMessage:(e,t)=>r.mutate({messageId:e,data:t}),removeVoiceMessage:e=>n.mutate(e),isLoading:s.isLoading,isError:s.isError}}(e.id),[ce,de]=a.useState(""),[ue,me]=a.useState(!1),[he,Pe]=a.useState(!1),[Me,Re]=a.useState(null),[Te,_e]=a.useState(!1),[De,Oe]=a.useState(null),Ue=a.useRef(null),Fe=a.useRef(null),Le=a.useRef(null),$e=U(-20),ze=U(0),Ve=U(0),qe=U(.3),We=U(1),Qe=ee(),{typingUsers:He,handleInputChange:Ke,handleMessageSend:Be}=function({roomId:e,currentUserId:t,currentUserName:s,realtimeClient:r,typingTimeout:n=3e3,debounceDelay:i=500}){const[o,l]=a.useState([]),[c,d]=a.useState(!1),u=a.useRef(void 0),m=a.useRef(void 0),h=a.useRef(0),p=a.useCallback(()=>{if(!r)return;const a=Date.now();a-h.current<i||(h.current=a,r.emit("typing_start",{roomId:e,userId:t,userName:s}).catch(()=>{}))},[r,e,t,s,i]),g=a.useCallback(()=>{r&&r.emit("typing_stop",{roomId:e,userId:t}).catch(()=>{})},[r,e,t]),f=a.useCallback(()=>{c||(d(!0),p(),u.current&&clearTimeout(u.current),u.current=setTimeout(()=>{x()},n))},[c,n,p]),x=a.useCallback(()=>{c&&(d(!1),g(),u.current&&(clearTimeout(u.current),u.current=void 0))},[c,g]),y=a.useCallback(e=>{m.current&&clearTimeout(m.current),e.trim().length>0?m.current=setTimeout(()=>{f()},i):x()},[f,x,i]),v=a.useCallback(()=>{x(),m.current&&(clearTimeout(m.current),m.current=void 0)},[x]);return a.useEffect(()=>{if(!r)return;const a=a=>{const s=a;if(s.roomId!==e||s.userId===t||!s.userId||!s.userName)return;const r=s.userId,n=s.userName;l(e=>e.some(e=>e.userId===r)?e:[...e,{userId:r,userName:n,startedAt:s.startedAt??(new Date).toISOString()}])},s=t=>{const a=t;a.roomId===e&&a.userId&&l(e=>e.filter(e=>e.userId!==a.userId))};return r.on("typing_start",a),r.on("typing_stop",s),()=>{r.off("typing_start",a),r.off("typing_stop",s)}},[r,e,t]),a.useEffect(()=>()=>{u.current&&clearTimeout(u.current),m.current&&clearTimeout(m.current),c&&g()},[c,g]),{typingUsers:o,isTyping:c,startTyping:f,stopTyping:x,handleInputChange:y,handleMessageSend:v}}({roomId:e.id,currentUserId:t,currentUserName:r,realtimeClient:_});a.useEffect(()=>{$e.value=te(0),ze.value=te(1)},[$e,ze]),a.useEffect(()=>{He.length>0?(Ve.value=te(1),qe.value=V(q(F(1),F(.3))),We.value=V(q(F(1.2),F(1)))):Ve.value=te(0)},[He.length,Ve,qe,We]);const Ge=L(()=>({transform:[{translateY:$e.value}],opacity:ze.value})),Ye=L(()=>({opacity:Ve.value})),Xe=L(()=>({opacity:qe.value})),et=L(()=>({transform:[{scale:We.value}]})),tt=ee(),at=ee(),st=K(),rt=ee(),nt=K(),it=ee(),ot=K(),ct=ee(),dt=K(),ut=ee(),mt=K(),ht=ee(),pt=K(),gt=U(0),xt=U(0);a.useEffect(()=>{he?(gt.value=te(1),xt.value=te(1)):(gt.value=te(0),xt.value=te(0))},[he,gt,xt]);const yt=L(()=>({opacity:gt.value,height:300*xt.value})),vt=L(()=>({opacity:1,transform:[{scale:1}]})),wt=L(()=>({opacity:1,transform:[{translateY:0},{scale:1}]})),bt=L(()=>({transform:[{scale:1}]})),jt=L(()=>({opacity:1,transform:[{translateY:0}]})),{activeCall:Nt,incomingCall:It,initiateCall:St,answerCall:Et,declineCall:Ct,endCall:At,toggleMute:kt,toggleVideo:Pt}=ft(e.id,t,r,n),Mt=a.useCallback(()=>{Ue.current&&(Ue.current.scrollTop=Ue.current.scrollHeight)},[]);a.useEffect(()=>{Mt()},[T,Mt]);const Rt=a.useCallback(()=>{const e=T&&T.length>0?T[T.length-1]:null;(null==e?void 0:e.id)&&G(e.id).catch(()=>{})},[T,G]);a.useEffect(()=>{Rt()},[e.id,Rt]),a.useEffect(()=>{const e=e=>{"Escape"===e.key&&(ue?(me(!1),e.preventDefault()):he?(Pe(!1),e.preventDefault()):Me&&(Re(null),e.preventDefault()))};return window.addEventListener("keydown",e),()=>{window.removeEventListener("keydown",e)}},[ue,he,Me]),a.useEffect(()=>{He.length>0&&Mt()},[He,Mt]);const Tt=(e,t="text")=>{if(e.trim()||"text"!==t)try{O.trigger("light");if(!B(e))return void Bt.warn("ChatWindowNew sendMessage returned null",{content:e,type:t});de(""),me(!1),Be(),"text"===t&&p.success("Message sent!",{duration:1500,position:"top-center"})}catch(a){const s=a instanceof Error?a:new Error(String(a));Bt.error("ChatWindowNew handleSendMessage error",s,{content:e,type:t}),p.error("Failed to send message. Please try again.")}},_t=(e,t)=>{try{O.trigger("selection"),J(e,t).catch(a=>{const s=a instanceof Error?a:new Error(String(a));Bt.error("ChatWindowNew handleReaction error",s,{messageId:e,emoji:t}),p.error("Failed to add reaction. Please try again.")}),Re(null)}catch(a){const s=a instanceof Error?a:new Error(String(a));Bt.error("ChatWindowNew handleReaction sync error",s,{messageId:e,emoji:t}),Re(null)}},Dt=D,Ot=T&&T.length>0?T[T.length-1]:null,Ut=Ot&&Ot.senderId!==t?Ot.content:null,Ft=Ot&&Ot.senderId!==t?Ot.senderName??null:null,Lt=He.length>0&&(null==(o=He[0])?void 0:o.userId)!==t?(null==(d=He[0])?void 0:d.userName)??null:null,$t=He.filter(e=>e.userId!==t).length>1,zt=ae({isVisible:!(!It||!e.matchedPetName)}),Vt=ae({isVisible:!!Nt});return s.jsxs(s.Fragment,{children:[s.jsx(xe,{inputRef:Fe}),s.jsx(ye,{lastText:Ut,senderName:Ft}),s.jsx(ve,{userName:Lt,multipleUsers:$t}),zt.shouldRender&&It&&e.matchedPetName&&s.jsx($,{style:zt.animatedStyle,children:s.jsx(Wt,{call:It,callerName:e.matchedPetName??"",...e.matchedPetPhoto?{callerAvatar:e.matchedPetPhoto}:{},onAccept:Et,onDecline:Ct})}),Vt.shouldRender&&Nt&&s.jsx($,{style:Vt.animatedStyle,children:s.jsx(lt,{session:Nt,onEndCall:At,onToggleMute:kt,onToggleVideo:Pt})}),s.jsxs("div",{className:"flex flex-col h-full",children:[s.jsx($,{style:Ge,className:"glass-strong border-b border-white/20 p-4 shadow-xl backdrop-blur-2xl",children:s.jsxs("div",{className:"flex items-center gap-3",children:[i&&s.jsx(z,{variant:"ghost",size:"icon",onClick:i,className:"md:hidden","aria-label":"Back to chat list",children:s.jsx(N,{size:20})}),s.jsxs(W,{className:"w-10 h-10 ring-2 ring-white/30",children:[s.jsx(Q,{src:e.matchedPetPhoto||void 0,alt:e.matchedPetName||void 0}),s.jsx(H,{className:"bg-linear-to-br from-primary to-accent text-white font-bold",children:(null==(u=e.matchedPetName)?void 0:u[0])||"?"})]}),s.jsxs("div",{className:"flex-1",children:[s.jsx("h2",{className:"font-bold text-foreground",children:e.matchedPetName||"Unknown"}),He.length>0&&s.jsxs($,{style:Ye,className:"text-xs text-primary flex items-center gap-1",children:[s.jsx($,{style:Xe,children:1===He.length?`${(null==(m=He[0])?void 0:m.userName)??"Someone"} is typing`:`${He.length} people are typing`}),s.jsx($,{style:et,children:"..."})]})]}),s.jsx($,{style:Qe.animatedStyle,children:s.jsx(z,{variant:"ghost",size:"icon",className:"shrink-0",onClick:()=>{try{O.trigger("heavy");const t=e.matchedPetId,a=e.matchedPetName;t&&a?(St(t,a,e.matchedPetPhoto||void 0,"video").catch(e=>{const s=e instanceof Error?e:new Error(String(e));Bt.error("ChatWindowNew handleVideoCall error",s,{petId:t,petName:a}),p.error("Failed to start video call. Please try again.")}),p.info("Starting video call...")):(Bt.warn("ChatWindowNew handleVideoCall missing petId or petName",{petId:t,petName:a}),p.error("Unable to start call. Pet information is missing."))}catch(t){const e=t instanceof Error?t:new Error(String(t));Bt.error("ChatWindowNew handleVideoCall sync error",e),p.error("Failed to start video call. Please try again.")}},onMouseEnter:Qe.handleEnter,onMouseLeave:Qe.handleLeave,title:"Start video call","aria-label":"Start video call",children:s.jsx(c,{size:24,weight:"regular"})})}),s.jsx($,{style:at.animatedStyle,children:s.jsx(z,{variant:"ghost",size:"icon",className:"shrink-0",onClick:()=>{try{O.trigger("heavy");const t=e.matchedPetId,a=e.matchedPetName;t&&a?(St(t,a,e.matchedPetPhoto||void 0,"voice").catch(e=>{const s=e instanceof Error?e:new Error(String(e));Bt.error("ChatWindowNew handleVoiceCall error",s,{petId:t,petName:a}),p.error("Failed to start voice call. Please try again.")}),p.info("Starting voice call...")):(Bt.warn("ChatWindowNew handleVoiceCall missing petId or petName",{petId:t,petName:a}),p.error("Unable to start call. Pet information is missing."))}catch(t){const e=t instanceof Error?t:new Error(String(t));Bt.error("ChatWindowNew handleVoiceCall sync error",e),p.error("Failed to start voice call. Please try again.")}},onMouseEnter:at.handleEnter,onMouseLeave:at.handleLeave,title:"Start voice call","aria-label":"Start voice call",children:s.jsx(y,{size:24,weight:"regular"})})}),s.jsx(z,{variant:"ghost",size:"icon",className:"shrink-0","aria-label":"Chat options menu",children:s.jsx(I,{size:24,weight:"bold"})})]})}),j?s.jsx(we,{messages:T||[],currentUserId:t,currentUserName:r,typingUsers:He,onReaction:_t,onTranslate:()=>{}}):s.jsxs(s.Fragment,{children:[s.jsx("div",{ref:Ue,className:"flex-1 overflow-y-auto p-4 space-y-6",children:Dt.map(e=>s.jsxs("div",{className:"space-y-4",children:[s.jsx($,{className:"flex justify-center",style:vt,children:s.jsx("div",{className:"glass-effect px-4 py-1.5 rounded-full text-xs font-medium text-muted-foreground shadow-sm",children:e.date})}),e.messages.map(e=>{var a,r;const n=e.senderId===t;return s.jsxs($,{className:"flex items-end gap-2 "+(n?"flex-row-reverse":"flex-row"),style:wt,children:[!n&&s.jsxs(W,{className:"w-8 h-8 ring-2 ring-white/20 shrink-0",children:[s.jsx(Q,{src:e.senderAvatar||void 0,alt:e.senderName||void 0}),s.jsx(H,{className:"bg-linear-to-br from-secondary to-primary text-white text-xs font-bold",children:(null==(a=e.senderName)?void 0:a[0])||"?"})]}),s.jsxs("div",{className:"flex flex-col max-w-[75%] "+(n?"items-end":"items-start"),children:[s.jsxs($,{style:tt.animatedStyle,onMouseEnter:tt.handleEnter,onMouseLeave:tt.handleLeave,className:`relative group ${"sticker"===e.type?"p-0":"p-3"} rounded-2xl shadow-lg ${n?"bg-linear-to-br from-primary to-accent text-white":"glass-strong backdrop-blur-xl border border-white/20"}`,children:["text"===e.type&&s.jsx("p",{className:"text-sm wrap-break-word",children:e.content}),"sticker"===e.type&&s.jsx("div",{className:"text-5xl p-2",children:e.content}),"voice"===e.type&&(null==X?void 0:X[e.id])&&s.jsxs($,{style:st.animatedStyle,onClick:()=>(e=>{if(!X)return;const t=X[e];if(!t)return;if(De===e)return Le.current&&(Le.current.pause(),Le.current=null),void Oe(null);Le.current&&(Le.current.pause(),Le.current=null);const a=new Audio(t.blob);a.onended=()=>{Oe(null),Le.current=null},a.onerror=()=>{Bt.error("ChatWindowNew audio playback error",new Error("Audio playback failed"),{messageId:e}),p.error("Failed to play voice message. Please try again."),Oe(null),Le.current=null},a.play().catch(t=>{const a=t instanceof Error?t:new Error(String(t));Bt.error("ChatWindowNew audio.play() error",a,{messageId:e}),p.error("Failed to play voice message. Please try again."),Oe(null),Le.current=null}),Le.current=a,Oe(e)})(e.id),className:"flex items-center gap-2 min-w-[200px] cursor-pointer",onMouseEnter:at.handleEnter,onMouseLeave:at.handleLeave,children:[s.jsx($,{style:at.animatedStyle,className:"w-8 h-8 rounded-full bg-white/20 flex items-center justify-center",children:De===e.id?s.jsx(S,{size:16,weight:"fill"}):s.jsx(E,{size:16,weight:"fill"})}),s.jsx("div",{className:"flex-1 h-8 flex items-center gap-0.5",children:null==(r=X[e.id])?void 0:r.waveform.slice(0,30).map((e,t)=>s.jsx("div",{className:"w-1 bg-white/60 rounded-full transition-opacity",style:{height:`${Math.max(24*e,4)}px`}},t))}),s.jsx("span",{className:"text-xs opacity-80",children:(()=>{const t=X[e.id];return t?`${Math.floor(t.duration/60)}:${(t.duration%60).toString().padStart(2,"0")}`:null})()})]}),s.jsxs(be,{open:Me===e.id,onOpenChange:t=>Re(t?e.id:null),children:[s.jsx(je,{asChild:!0,children:s.jsx($,{style:nt.animatedStyle,onClick:()=>{},className:"absolute -bottom-2 -right-2 w-7 h-7 rounded-full bg-white shadow-lg flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity cursor-pointer",onMouseEnter:rt.handleEnter,onMouseLeave:rt.handleLeave,children:s.jsx(C,{size:14,weight:"fill",className:"text-red-500"})})}),s.jsx(Ne,{className:"w-auto p-2 glass-strong backdrop-blur-2xl border-white/30",side:"top",children:s.jsx("div",{className:"flex gap-1",children:Ie.slice(0,6).map(t=>s.jsx($,{style:nt.animatedStyle,onClick:()=>_t(e.id,t),className:"text-2xl p-2 rounded-lg hover:bg-white/20 transition-colors cursor-pointer",onMouseEnter:rt.handleEnter,onMouseLeave:rt.handleLeave,children:t},t))})})]})]}),(()=>{const t=ge(e.reactions);return t.length>0&&s.jsx($,{className:"flex gap-1 mt-1 px-2",style:bt,children:t.map((e,t)=>s.jsx($,{style:rt.animatedStyle,onMouseEnter:rt.handleEnter,onMouseLeave:rt.handleLeave,className:"text-lg bg-white/80 rounded-full px-2 py-0.5 shadow-sm cursor-pointer",title:e.userName,children:e.emoji},t))})})(),s.jsxs("div",{className:"flex items-center gap-1 mt-1 px-1",children:[s.jsx("span",{className:"text-xs text-muted-foreground",children:Se(e.timestamp)}),n&&s.jsx("span",{className:"text-muted-foreground",children:"read"===e.status?s.jsx(f,{size:14,weight:"bold",className:"text-primary"}):s.jsx(x,{size:14,weight:"bold"})})]})]})]},e.id)})]},e.date))}),He.length>0&&s.jsxs($,{className:"flex items-end gap-2 flex-row p-4",style:jt,children:[s.jsx(W,{className:"w-8 h-8 ring-2 ring-white/20 shrink-0",children:s.jsx(H,{className:"bg-linear-to-br from-secondary to-primary text-white text-xs font-bold",children:(null==(g=null==(h=He[0])?void 0:h.userName)?void 0:g[0])||"?"})}),s.jsx(Ee,{showTyping:!0,isIncoming:!0,children:s.jsx("div",{})})]},"typing-indicators")]}),s.jsxs($,{className:"glass-strong border-t border-white/20 p-4 shadow-2xl backdrop-blur-2xl",style:L(()=>({opacity:1,transform:[{translateY:0}]})),children:[he&&s.jsx($,{style:yt,className:"mb-3 overflow-hidden",children:s.jsxs("div",{className:"glass-effect rounded-2xl p-3 space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between mb-2",children:[s.jsxs("h4",{className:"text-sm font-semibold flex items-center gap-2",children:[s.jsx(A,{size:16,weight:"fill",className:"text-primary"}),"Quick Templates"]}),s.jsx(z,{variant:"ghost",size:"sm",onClick:()=>Pe(!1),children:s.jsx(k,{size:16})})]}),s.jsx("div",{className:"grid grid-cols-1 gap-2",children:Ce.slice(0,4).map(e=>s.jsxs($,{style:[it.animatedStyle,ot.animatedStyle],onClick:()=>(e=>{var t;de(e),Pe(!1),null==(t=Fe.current)||t.focus()})(e.text),onMouseEnter:it.handleEnter,onMouseLeave:it.handleLeave,onMouseDown:ot.handlePress,className:"text-left p-2 rounded-lg glass-effect hover:glass-strong transition-all text-sm cursor-pointer",children:[s.jsx("span",{className:"mr-2",children:e.icon}),e.title]},e.id))})]})}),Te?s.jsx(Ae,{onRecorded:(a,s,i)=>{try{const o=pe(),l=new FileReader;l.onloadend=()=>{try{const a=l.result;if(!a)return Bt.error("ChatWindowNew handleVoiceRecorded empty result",new Error("FileReader returned empty result"),{messageId:o,duration:s}),p.error("Failed to process voice message. Please try again."),void _e(!1);le(o,{blob:a,duration:s,waveform:i});const c={id:o,roomId:e.id,senderId:t,senderName:r,content:`Voice message (${Math.floor(s/60)}:${(s%60).toString().padStart(2,"0")})`,type:"voice",timestamp:(new Date).toISOString(),createdAt:(new Date).toISOString(),status:"sent",reactions:[]};void 0!==n&&(c.senderAvatar=n),Y(e=>[...e||[],c]),_e(!1),p.success("Voice message sent!",{duration:1500,position:"top-center"})}catch(a){const e=a instanceof Error?a:new Error(String(a));Bt.error("ChatWindowNew handleVoiceRecorded onloadend error",e,{messageId:o}),p.error("Failed to process voice message. Please try again."),_e(!1)}},l.onerror=()=>{Bt.error("ChatWindowNew handleVoiceRecorded FileReader error",new Error("FileReader failed"),{messageId:o}),p.error("Failed to read voice message. Please try again."),_e(!1)},l.readAsDataURL(a)}catch(o){const e=o instanceof Error?o:new Error(String(o));Bt.error("ChatWindowNew handleVoiceRecorded error",e,{duration:s}),p.error("Failed to record voice message. Please try again."),_e(!1)}},onCancel:()=>{_e(!1),p.info("Recording cancelled",{duration:1e3,position:"top-center"})},maxDuration:120}):s.jsxs("div",{className:"flex items-end gap-2",children:[s.jsx(z,{variant:"ghost",size:"icon",onClick:()=>Pe(!he),className:"shrink-0","aria-label":he?"Close message templates":"Open message templates","aria-expanded":he,children:s.jsx(P,{size:24,weight:he?"fill":"regular"})}),s.jsxs(be,{open:ue,onOpenChange:me,children:[s.jsx(je,{asChild:!0,children:s.jsx(z,{variant:"ghost",size:"icon",className:"shrink-0","aria-label":ue?"Close stickers and emojis":"Open stickers and emojis","aria-expanded":ue,children:s.jsx(M,{size:24,weight:ue?"fill":"regular"})})}),s.jsx(Ne,{className:"w-80 glass-strong backdrop-blur-2xl border-white/30",side:"top",children:s.jsxs(se,{defaultValue:"stickers",className:"w-full",children:[s.jsxs(re,{className:"grid w-full grid-cols-2",children:[s.jsx(ne,{value:"stickers",children:"Stickers"}),s.jsx(ne,{value:"emojis",children:"Reactions"})]}),s.jsx(ie,{value:"stickers",className:"mt-3",children:s.jsx("div",{className:"grid grid-cols-6 gap-2",children:ke.map(e=>s.jsx($,{style:[dt.animatedStyle,ct.animatedStyle],onClick:()=>Tt(e.emoji,"sticker"),onKeyDown:t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),Tt(e.emoji,"sticker"))},className:"text-3xl p-2 rounded-xl hover:bg-white/20 transition-colors cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2",onMouseEnter:ct.handleEnter,onMouseLeave:ct.handleLeave,title:e.label,role:"button","aria-label":`Send ${e.label} sticker`,tabIndex:0,children:e.emoji},e.id))})}),s.jsx(ie,{value:"emojis",className:"mt-3",children:s.jsx("div",{className:"grid grid-cols-6 gap-2",children:Ie.map(e=>s.jsx($,{style:[mt.animatedStyle,ut.animatedStyle],onClick:()=>Tt(e,"text"),onKeyDown:t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),Tt(e,"text"))},className:"text-2xl p-2 rounded-xl hover:bg-white/20 transition-colors text-center cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2",onMouseEnter:ut.handleEnter,onMouseLeave:ut.handleLeave,role:"button","aria-label":`Send ${e} emoji`,tabIndex:0,children:e},e))})})]})})]}),s.jsx("div",{className:"flex-1 relative",children:s.jsx(oe,{id:"chat-input",ref:Fe,value:ce,onChange:e=>{return t=e.target.value,de(t),void Ke(t);var t},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),Tt(ce,"text"))},placeholder:"Type a message...",className:"pr-12 glass-effect border-white/30 focus:border-primary/50 backdrop-blur-xl","aria-label":"Message input"})}),s.jsx(z,{onClick:()=>{O.trigger("medium"),_e(!0)},size:"icon",variant:"ghost",className:"shrink-0","aria-label":"Record voice message",children:s.jsx(l,{size:20,weight:"regular"})}),s.jsx($,{style:[ht.animatedStyle,pt.animatedStyle],children:s.jsx(z,{onClick:()=>Tt(ce,"text"),disabled:!ce.trim(),size:"icon",className:"shrink-0 bg-linear-to-br from-primary to-accent hover:shadow-lg transition-all disabled:opacity-50",onMouseEnter:ht.handleEnter,onMouseLeave:ht.handleLeave,"aria-label":"Send message",children:s.jsx(R,{size:20,weight:"fill"})})})]})]})]})]})}const Gt=T("ChatApi");const Yt=new class{async sendMessage(e,t){try{return(await le.post(ce.CHAT.SEND_MESSAGE(e),t)).data}catch(a){const s=a instanceof Error?a:new Error(String(a));throw Gt.error("Failed to send message",s,{roomId:e,type:t.type}),s}}async getMessages(e,t){try{const a=t?`?cursor=${t}`:"";return(await le.get(`${ce.CHAT.MESSAGES(e)}${a}`)).data}catch(a){const s=a instanceof Error?a:new Error(String(a));throw Gt.error("Failed to get messages",s,{roomId:e,cursor:t}),s}}async markAsRead(e,t){try{await le.post(`${ce.CHAT.MARK_READ(e)}`,{messageId:t})}catch(a){const s=a instanceof Error?a:new Error(String(a));throw Gt.error("Failed to mark as read",s,{roomId:e,messageId:t}),s}}async addReaction(e,t){try{return(await le.post(`/api/v1/chat/messages/${e}/reactions`,t)).data}catch(a){const s=a instanceof Error?a:new Error(String(a));throw Gt.error("Failed to add reaction",s,{messageId:e,reaction:t.reaction}),s}}async sendTypingIndicator(e,t){try{await le.post(`/api/v1/chat/rooms/${e}/typing`,t)}catch(a){const s=a instanceof Error?a:new Error(String(a));throw Gt.error("Failed to send typing indicator",s,{roomId:e,userId:t.userId}),s}}async deleteMessage(e,t=!1){try{await le.delete(`/api/v1/chat/messages/${e}`,{headers:{"Content-Type":"application/json"},body:JSON.stringify({forEveryone:t})})}catch(a){const s=a instanceof Error?a:new Error(String(a));throw Gt.error("Failed to delete message",s,{messageId:e,forEveryone:t}),s}}async getConversations(){try{return(await le.get(ce.CHAT.CONVERSATIONS)).data}catch(e){const t=e instanceof Error?e:new Error(String(e));return Gt.error("Failed to get conversations",t),[]}}async getConversation(e){try{return(await le.get(ce.CHAT.CONVERSATION(e))).data}catch(t){const a=t instanceof Error?t:new Error(String(t));throw Gt.error("Failed to get conversation",a,{conversationId:e}),a}}},Xt=Object.freeze(Object.defineProperty({__proto__:null,chatApi:Yt},Symbol.toStringTag,{value:"Module"})),Zt=T("ChatService"),ea=new Map,ta=new Map;const aa=T("ChatView");const sa=Object.freeze(Object.defineProperty({__proto__:null,default:function(){const{t:e}=de(),[t]=B("matches",[]),[r]=B("all-pets",[]),[n]=B("user-pets",[]),[i,o]=B("chat-rooms",[]),[l,c]=a.useState(null),[d,u]=a.useState(!0),m=function(){const[e,t]=a.useState(void 0);return a.useEffect(()=>{const e=window.matchMedia("(max-width: 767px)"),a=()=>{t(window.innerWidth<768)};return e.addEventListener("change",a),t(window.innerWidth<768),()=>e.removeEventListener("change",a)},[]),!!e}(),h=Array.isArray(n)&&n.length>0?n[0]:void 0,p=ue({isVisible:!d,direction:"down",duration:300}),g=ue({isVisible:!h,direction:"up",duration:300}),f=ue({isVisible:!m||!l,direction:"fade",duration:250}),x=ue({isVisible:Boolean(l&&(!m||l)),direction:"fade",duration:250}),y=ue({isVisible:!l&&!m,direction:"fade",duration:300}),v=U(1),w=U(0);a.useEffect(()=>{void 0!==n&&void 0!==i&&u(!1)},[n,i]),a.useEffect(()=>{if(!h||!Array.isArray(t))return;const e=t.filter(e=>"active"===e.status),a=new Set(Array.isArray(i)?i.map(e=>e.matchId):[]),s=[];e.forEach(e=>{if(!a.has(e.id)){const t=Array.isArray(r)?r.find(t=>t.id===e.matchedPetId):void 0;t&&h&&s.push(Pe(e.id,e.petId,e.matchedPetId,h.name,t.name,h.photo,t.photo))}}),s.length>0&&o(e=>Array.isArray(e)?[...e,...s]:s)},[t,h,r,i,o]),a.useEffect(()=>{(async()=>{if(!Array.isArray(i))return;const e=await Promise.all(i.map(async e=>{try{const t=(await async function(e,t){try{const a=await Yt.getMessages(e,t);return t||ta.set(e,a.messages),a.messages.forEach(e=>{ea.set(e.id,e)}),a}catch(a){return Zt.error("Get messages error",a instanceof Error?a:new Error(String(a)),{roomId:e,cursor:t}),{messages:ta.get(e)||[]}}}(e.id)).messages;if(Array.isArray(t)&&t.length>0){const a=t[t.length-1],s=t.filter(e=>"read"!==e.status&&e.senderId!==(null==h?void 0:h.id)).length;return{...e,...a&&{lastMessage:a},...void 0!==s&&{unreadCount:s},updatedAt:(null==a?void 0:a.timestamp)??e.updatedAt}}}catch(t){const e=t instanceof Error?t:new Error(String(t));aa.error("Error loading messages",e)}return e}));o(()=>e.sort((e,t)=>{const a=e.updatedAt?new Date(e.updatedAt).getTime():0;return(t.updatedAt?new Date(t.updatedAt).getTime():0)-a}))})()},[l,i,h,o]),a.useEffect(()=>{l||m?(v.value=1,w.value=0):(v.value=V(q(F(1.1),F(1))),w.value=V(q(F(5),F(-5),F(0))))},[l,m,v,w]);const b=a.useCallback(e=>{c(e)},[]),j=a.useCallback(()=>{c(null)},[]),N=L(()=>({transform:[{scale:v.value},{rotate:`${w.value}deg`}]}));if(d)return null;if(!h)return s.jsx("div",{className:"flex flex-col items-center justify-center min-h-[60vh] text-center px-4",children:s.jsxs($,{style:g.style,className:"glass-strong p-8 rounded-3xl max-w-md",children:[s.jsx("h2",{className:"text-2xl font-bold mb-2",children:e.chat.createProfile}),s.jsx("p",{className:"text-muted-foreground",children:e.chat.createProfileDesc})]})});const I=l&&(!m||l),S=!m||!l;return s.jsx(He,{direction:"up",children:s.jsxs("div",{className:"h-[calc(100vh-8rem)]",children:[s.jsxs($,{style:p.style,className:"mb-6",children:[s.jsx("h2",{className:"text-2xl font-bold mb-2",children:e.chat.title}),s.jsxs("p",{className:"text-muted-foreground",children:[(i||[]).length," ",1===(i||[]).length?e.chat.subtitle:e.chat.subtitlePlural]})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-12 gap-6 h-[calc(100%-5rem)]",children:[S&&s.jsx($,{style:f.style,className:"md:col-span-4 glass-strong rounded-3xl p-4 shadow-xl backdrop-blur-2xl border border-white/20 overflow-hidden",children:s.jsx(Vt,{rooms:i||[],onSelectRoom:b,...(null==l?void 0:l.id)&&{selectedRoomId:l.id}})}),I&&l&&s.jsx($,{style:x.style,className:(m?"col-span-1":"md:col-span-8")+" glass-strong rounded-3xl shadow-xl backdrop-blur-2xl border border-white/20 overflow-hidden flex flex-col",children:s.jsx(Me,{children:s.jsx(Jt,{room:l,currentUserId:h.id,currentUserName:h.name,currentUserAvatar:h.photo,...m&&{onBack:j}})})}),!l&&!m&&s.jsx($,{style:y.style,className:"md:col-span-8 glass-effect rounded-3xl flex items-center justify-center border border-white/20",children:s.jsxs("div",{className:"text-center px-4",children:[s.jsx($,{style:N,className:"text-6xl mb-4",children:"ðŸ’¬"}),s.jsx("h3",{className:"text-xl font-semibold mb-2",children:e.chat.selectConversation}),s.jsx("p",{className:"text-muted-foreground",children:e.chat.selectConversationDesc})]})})]})]})},"chat-view")}},Symbol.toStringTag,{value:"Module"}));export{lt as C,Ke as F,Ye as a,Xe as b,Ge as c,vt as d,zt as e,Xt as f,sa as g,Lt as m,Ft as p,Ze as q,ft as u};
