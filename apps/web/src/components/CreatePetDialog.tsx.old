import { useCallback, useState, useEffect, lazy, Suspense } from 'react';
import { useStorage } from '@/hooks/use-storage';
import {
  X,
  Dog,
  Cat,
  Bird,
  Fish,
  Rabbit,
  PawPrint,
  ArrowLeft,
  ArrowRight,
  Check,
  Sparkle,
} from '@phosphor-icons/react';
import { useHoverLift } from '@/effects/reanimated/use-hover-lift';
import { useBounceOnTap } from '@/effects/reanimated/use-bounce-on-tap';
import { useAnimatePresence } from '@/effects/reanimated';
import {
  useSharedValue,
  useAnimatedStyle,
  withSpring,
  withTiming,
  withRepeat,
  withSequence,
  MotionView,
} from '@petspark/motion';
import type { AnimatedStyle } from '@/effects/reanimated/animated-view';
import { Button } from '@/components/ui/button';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Badge } from '@/components/ui/badge';
import { toast } from 'sonner';
import type { Pet } from '@/lib/types';
import { ProgressiveImage } from '@/components/enhanced/ProgressiveImage';
import {
  getTemplatesByType,
  type PetType,
  type PetProfileTemplate,
} from '@/lib/pet-profile-templates';

// Lazy load heavy components
const PetPhotoAnalyzer = lazy(() =>
  import('@/components/PetPhotoAnalyzer').then((module) => ({ default: module.default }))
);

type Step =
  | 'type'
  | 'template'
  | 'basics'
  | 'characteristics'
  | 'personality'
  | 'preferences'
  | 'photo'
  | 'complete';

const PET_TYPES = [
  { value: 'dog' as PetType, label: 'Dog', icon: Dog, emoji: 'üêï' },
  { value: 'cat' as PetType, label: 'Cat', icon: Cat, emoji: 'üêà' },
  { value: 'bird' as PetType, label: 'Bird', icon: Bird, emoji: 'ü¶ú' },
  { value: 'rabbit' as PetType, label: 'Rabbit', icon: Rabbit, emoji: 'üê∞' },
  { value: 'fish' as PetType, label: 'Fish', icon: Fish, emoji: 'üê†' },
  { value: 'other' as PetType, label: 'Other', icon: PawPrint, emoji: 'üêæ' },
];

const PERSONALITY_TRAITS: Record<PetType, string[]> = {
  dog: [
    'Playful',
    'Calm',
    'Energetic',
    'Gentle',
    'Social',
    'Independent',
    'Affectionate',
    'Loyal',
    'Friendly',
    'Protective',
  ],
  cat: [
    'Independent',
    'Playful',
    'Calm',
    'Affectionate',
    'Curious',
    'Gentle',
    'Social',
    'Vocal',
    'Lap Cat',
    'Adventurous',
  ],
  bird: [
    'Vocal',
    'Social',
    'Playful',
    'Calm',
    'Affectionate',
    'Independent',
    'Curious',
    'Musical',
    'Friendly',
    'Interactive',
  ],
  rabbit: [
    'Calm',
    'Playful',
    'Gentle',
    'Social',
    'Curious',
    'Affectionate',
    'Independent',
    'Active',
    'Friendly',
    'Cuddly',
  ],
  fish: [
    'Peaceful',
    'Active',
    'Social',
    'Solitary',
    'Hardy',
    'Delicate',
    'Colorful',
    'Bottom-dweller',
    'Surface-swimmer',
    'Schooling',
  ],
  other: [
    'Playful',
    'Calm',
    'Energetic',
    'Gentle',
    'Social',
    'Independent',
    'Affectionate',
    'Curious',
    'Friendly',
    'Active',
  ],
};

const INTERESTS: Record<PetType, string[]> = {
  dog: [
    'Fetch',
    'Swimming',
    'Hiking',
    'Running',
    'Cuddling',
    'Treats',
    'Toys',
    'Parks',
    'Beach',
    'Car Rides',
    'Training',
    'Agility',
  ],
  cat: [
    'Toys',
    'Laser Pointer',
    'Catnip',
    'Climbing',
    'Hunting',
    'Cuddling',
    'Treats',
    'Windows',
    'Scratching',
    'Exploring',
    'Napping',
    'Playing',
  ],
  bird: [
    'Singing',
    'Talking',
    'Flying',
    'Toys',
    'Treats',
    'Perching',
    'Foraging',
    'Social Time',
    'Music',
    'Training',
    'Exploring',
    'Playing',
  ],
  rabbit: [
    'Hopping',
    'Exploring',
    'Digging',
    'Chewing',
    'Treats',
    'Toys',
    'Cuddling',
    'Running',
    'Hiding',
    'Garden Time',
    'Playing',
    'Grooming',
  ],
  fish: [
    'Swimming',
    'Exploring',
    'Hiding',
    'Feeding Time',
    'Plants',
    'Decorations',
    'Schooling',
    'Bubble Nests',
    'Surface Activity',
    'Bottom Foraging',
  ],
  other: [
    'Exploring',
    'Treats',
    'Toys',
    'Cuddling',
    'Playing',
    'Exercise',
    'Social Time',
    'Training',
    'Napping',
    'Activities',
  ],
};

const LOOKING_FOR: Record<PetType, string[]> = {
  dog: [
    'Playdate',
    'Walking Buddy',
    'Best Friend',
    'Training Partner',
    'Adventure Buddy',
    'Park Companion',
  ],
  cat: [
    'Playmate',
    'Cuddle Buddy',
    'Window Watching Friend',
    'Nap Companion',
    'Play Partner',
    'Friend',
  ],
  bird: [
    'Cage Mate',
    'Singing Partner',
    'Play Companion',
    'Social Buddy',
    'Friend',
    'Flock Member',
  ],
  rabbit: [
    'Bonded Pair',
    'Play Companion',
    'Cuddle Buddy',
    'Exercise Partner',
    'Friend',
    'Warren Mate',
  ],
  fish: [
    'Tank Mate',
    'School Member',
    'Peaceful Companion',
    'Breeding Partner',
    'Community Member',
    'Friend',
  ],
  other: ['Companion', 'Playmate', 'Friend', 'Social Buddy', 'Activity Partner', 'Best Friend'],
};

interface CreatePetDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  editingPet?: Pet | null;
}

export default function CreatePetDialog({ open, onOpenChange, editingPet }: CreatePetDialogProps) {
  const [, setUserPets] = useStorage<Pet[]>('user-pets', []);
  const [, setAllPets] = useStorage<Pet[]>('all-pets', []);

  const [currentStep, setCurrentStep] = useState<Step>('type');
  const [petType, setPetType] = useState<PetType>('dog');
  const [selectedTemplate, setSelectedTemplate] = useState<PetProfileTemplate | null>(null);
  const [name, setName] = useState('');
  const [breed, setBreed] = useState('');
  const [age, setAge] = useState('');
  const [gender, setGender] = useState<'male' | 'female'>('male');
  const [size, setSize] = useState<'small' | 'medium' | 'large' | 'extra-large'>('medium');
  const [photo, setPhoto] = useState('');
  const [bio, setBio] = useState('');
  const [location, setLocation] = useState('');
  const [personality, setPersonality] = useState<string[]>([]);
  const [interests, setInterests] = useState<string[]>([]);
  const [lookingFor, setLookingFor] = useState<string[]>([]);

  // Animation hooks for step transitions
  const stepOpacity = useSharedValue<number>(1);
  const stepX = useSharedValue<number>(0);

  // Animation hooks for interactive elements
  const petTypeButtonHover = useHoverLift();
  const petTypeButtonTap = useBounceOnTap();

  // Animation for emoji rotation
  const emojiRotation = useSharedValue<number>(0);

  useEffect(() => {
    emojiRotation.value = withRepeat(
      withSequence(
        withTiming(10, { duration: 1000 }),
        withTiming(-10, { duration: 1000 }),
        withTiming(0, { duration: 1000 })
      ),
      -1,
      false
    ) as unknown as number;
  }, [emojiRotation]);

  const emojiStyle = useAnimatedStyle(() => ({
    transform: [{ rotate: `${emojiRotation.value}deg` }],
  })) as AnimatedStyle;

  // Static animated style for pet type selection indicator (used in render)
  const petTypeIndicatorStyle = useAnimatedStyle(() => ({
    transform: [{ scale: 1 }],
  })) as AnimatedStyle;

  // Presence hooks for conditional rendering
  const photoPresence = useAnimatePresence({ isVisible: !!photo });
  const completeStepPresence = useAnimatePresence({ isVisible: currentStep !== 'complete' });

  useEffect(() => {
    // Animate step transitions
    stepOpacity.value = withSpring(0, { damping: 20, stiffness: 300 }) as unknown as number;
    stepX.value = withSpring(-20, { damping: 20, stiffness: 300 }) as unknown as number;

    const timeoutId = setTimeout(() => {
      stepOpacity.value = withSpring(1, { damping: 20, stiffness: 300 }) as unknown as number;
      stepX.value = withSpring(0, { damping: 20, stiffness: 300 }) as unknown as number;
    }, 50);

    return () => {
      clearTimeout(timeoutId);
    };
  }, [currentStep, stepOpacity, stepX]);

  const stepStyle = useAnimatedStyle(() => ({
    opacity: stepOpacity.value,
    transform: [{ translateX: stepX.value }],
  })) as AnimatedStyle;

  // Progress bar animation
  const progressWidth = useSharedValue<number>(0);

  // Calculate step progress
  const stepProgress = useCallback(() => {
    const steps: Step[] = [
      'type',
      'basics',
      'characteristics',
      'photo',
      'personality',
      'preferences',
      'complete',
    ];
    return ((steps.indexOf(currentStep) + 1) / steps.length) * 100;
  }, [currentStep]);

  useEffect(() => {
    progressWidth.value = withTiming(stepProgress(), { duration: 300 }) as unknown as number;
  }, [currentStep, stepProgress, progressWidth]);

  const progressStyle = useAnimatedStyle(() => ({
    width: `${progressWidth.value}%`,
  })) as AnimatedStyle;

  useEffect(() => {
    if (editingPet) {
      setCurrentStep('basics');
      setSelectedTemplate(null);
      setName(editingPet.name);
      setBreed(editingPet.breed);
      setAge(editingPet.age.toString());
      setGender(editingPet.gender);
      setSize(editingPet.size);
      setPhoto(editingPet.photo);
      setBio(editingPet.bio);
      setLocation(editingPet.location);
      setPersonality(editingPet.personality);
      setInterests(editingPet.interests);
      setLookingFor(editingPet.lookingFor);
    } else {
      resetForm();
    }
  }, [editingPet, open]);

  const resetForm = () => {
    setCurrentStep('type');
    setPetType('dog');
    setSelectedTemplate(null);
    setName('');
    setBreed('');
    setAge('');
    setGender('male');
    setSize('medium');
    setPhoto('');
    setBio('');
    setLocation('');
    setPersonality([]);
    setInterests([]);
    setLookingFor([]);
  };

  const applyTemplate = (template: PetProfileTemplate) => {
    setSelectedTemplate(template);
    if (template.defaults.size) setSize(template.defaults.size);
    if (template.defaults.breed) setBreed(template.defaults.breed);
    if (template.defaults.bio) setBio(template.defaults.bio);
    setPersonality(template.defaults.personality);
    setInterests(template.defaults.interests);
    setLookingFor(template.defaults.lookingFor);
  };

  const toggleArrayItem = (arr: string[], item: string, setter: (arr: string[]) => void) => {
    if (arr.includes(item)) {
      setter(arr.filter((i) => i !== item));
    } else {
      setter([...arr, item]);
    }
  };

  const handleNext = () => {
    const steps: Step[] = [
      'type',
      'template',
      'basics',
      'characteristics',
      'photo',
      'personality',
      'preferences',
      'complete',
    ];
    const currentIndex = steps.indexOf(currentStep);
    if (currentIndex >= 0 && currentIndex < steps.length - 1) {
      const nextStep = steps[currentIndex + 1];
      if (nextStep) {
        setCurrentStep(nextStep);
      }
    }
  };

  const handleBack = () => {
    const steps: Step[] = [
      'type',
      'template',
      'basics',
      'characteristics',
      'photo',
      'personality',
      'preferences',
      'complete',
    ];
    const currentIndex = steps.indexOf(currentStep);
    if (currentIndex > 0) {
      const prevStep = steps[currentIndex - 1];
      if (prevStep) {
        setCurrentStep(prevStep);
      }
    }
  };

  const skipToBasics = () => {
    setCurrentStep('basics');
  };

  const canProceed = () => {
    switch (currentStep) {
      case 'type':
        return !!petType;
      case 'template':
        return true;
      case 'basics':
        return !!(name && breed && age);
      case 'characteristics':
        return !!(gender && size && location);
      case 'photo':
        return !!photo;
      case 'personality':
        return personality.length > 0;
      case 'preferences':
        return interests.length > 0 && lookingFor.length > 0;
      default:
        return true;
    }
  };

  const handleSubmit = () => {
    if (!name || !breed || !age || !photo || !location) {
      toast.error('Please complete all required fields');
      return;
    }

    const petData: Pet = {
      id: editingPet?.id ?? `pet-${String(Date.now() ?? '')}`,
      name,
      breed,
      age: parseInt(age),
      gender,
      size,
      photo,
      photos: [photo],
      bio,
      location,
      personality,
      interests,
      lookingFor,
      ownerId: 'user-1',
      ownerName: 'You',
      verified: false,
      createdAt: editingPet?.createdAt ?? new Date().toISOString(),
    };

    if (editingPet) {
      void setUserPets((current) =>
        (current ?? []).map((p) => (p.id === editingPet.id ? petData : p))
      );
      void setAllPets((current) =>
        (current ?? []).map((p) => (p.id === editingPet.id ? petData : p))
      );

      toast.success('Pet profile updated!', {
        description: `${name}'s profile has been updated successfully.`,
      });
    } else {
      void setUserPets((current) => [...(current ?? []), petData]);
      void setAllPets((current) => [...(current ?? []), petData]);
      toast.success('Pet profile created! üéâ', {
        description: `${name} is ready to find perfect companions!`,
      });
    }

    onOpenChange(false);
    resetForm();
  };

  const renderStepContent = () => {
    switch (currentStep) {
      case 'type':
        return (
          <MotionView key="type" animatedStyle={stepStyle} className="space-y-6">
            <div className="text-center mb-6">
              <h3 className="text-2xl font-bold mb-2">What type of pet do you have?</h3>
              <p className="text-muted-foreground">
                Choose the option that best describes your companion
              </p>
            </div>
            <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
              {PET_TYPES.map((type) => {
                const Icon = type.icon;
                return (
                  <MotionView
                    key={type.value}
                    onClick={() => {
                      petTypeButtonTap.handlePress();
                      setPetType(type.value);
                      setTimeout(() => handleNext(), 400);
                    }}
                    className={`relative p-6 rounded-2xl border-2 transition-all duration-300 cursor-pointer ${petType === type.value
                      ? 'border-primary bg-primary/10 shadow-lg shadow-primary/20'
                      : 'border-border bg-card hover:border-primary/50 hover:bg-card/80'
                      }`}
                    onMouseEnter={petTypeButtonHover.handleEnter}
                    onMouseLeave={petTypeButtonHover.handleLeave}
                  >
                    <MotionView>
                      <div className="flex flex-col items-center gap-3">
                        <span className="text-4xl">{type.emoji}</span>
                        <Icon size={32} weight="duotone" className="text-primary" />
                        <span className="font-semibold text-lg">{type.label}</span>
                      </div>
                    </MotionView>
                    {petType === type.value && (
                      <MotionView
                        animatedStyle={petTypeIndicatorStyle}
                        className="absolute top-2 right-2 bg-primary text-primary-foreground rounded-full p-1"
                      >
                        <Check size={16} weight="bold" />
                      </MotionView>
                    )}
                  </MotionView>
                );
              })}
            </div>
          </MotionView>
        );

      case 'template': {
        const templates = getTemplatesByType(petType);
        return (
          <MotionView key="template" animatedStyle={stepStyle} className="space-y-6">
            <div className="text-center mb-6">
              <h3 className="text-2xl font-bold mb-2">Choose a profile template</h3>
              <p className="text-muted-foreground">
                Pre-fill your pet's profile with common traits, or skip to customize everything
              </p>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-100 overflow-y-auto pr-2">
              {templates.map((template) => (
                <MotionView
                  key={template.id}
                  onClick={() => {
                    applyTemplate(template);
                    setTimeout(() => handleNext(), 300);
                  }}
                  className={`relative p-4 rounded-xl border-2 text-left transition-all duration-300 cursor-pointer ${selectedTemplate?.id === template.id
                    ? 'border-primary bg-primary/10 shadow-lg shadow-primary/20'
                    : 'border-border bg-card hover:border-primary/50 hover:bg-card/80'
                    }`}
                >
                  <div className="flex items-start gap-3">
                    <span className="text-3xl shrink-0">{template.emoji}</span>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center justify-between mb-1">
                        <h4 className="font-semibold text-base">{template.name}</h4>
                        {selectedTemplate?.id === template.id && (
                          <MotionView className="bg-primary text-primary-foreground rounded-full p-1 shrink-0">
                            <Check size={14} weight="bold" />
                          </MotionView>
                        )}
                      </div>
                      <p className="text-sm text-muted-foreground line-clamp-2">
                        {template.description}
                      </p>
                      <div className="mt-2 flex flex-wrap gap-1">
                        {template.defaults.personality.slice(0, 3).map((trait) => (
                          <Badge key={trait} variant="secondary" className="text-xs">
                            {trait}
                          </Badge>
                        ))}
                        {template.defaults.personality.length > 3 && (
                          <Badge variant="outline" className="text-xs">
                            +{template.defaults.personality.length - 3}
                          </Badge>
                        )}
                      </div>
                    </div>
                  </div>
                </MotionView>
              ))}
            </div>
            <Button type="button" variant="outline" className="w-full" onClick={skipToBasics}>
              <Sparkle size={16} className="mr-2" />
              Skip & Customize From Scratch
            </Button>
          </MotionView>
        );
      }

      case 'basics':
        return (
          <MotionView key="basics" className="space-y-6">
            <div className="text-center mb-6">
              <h3 className="text-2xl font-bold mb-2">Tell us the basics</h3>
              <p className="text-muted-foreground">
                What's your {PET_TYPES.find((t) => t.value === petType)?.label.toLowerCase()}'s
                name, breed, and age?
              </p>
            </div>
            <div className="space-y-4">
              <div>
                <Label htmlFor="name">Name *</Label>
                <Input
                  id="name"
                  value={name}
                  onChange={(e) => { setName(e.target.value); }}
                  placeholder={`e.g., ${String(petType === 'dog' ? 'Max' : petType === 'cat' ? 'Whiskers' : petType === 'bird' ? 'Charlie' : petType === 'rabbit' ? 'Fluffy' : petType === 'fish' ? 'Bubbles' : 'Buddy' ?? '')}`}
                  className="mt-1"
                  autoFocus
                />
              </div>
              <div>
                <Label htmlFor="breed">Breed / Species *</Label>
                <Input
                  id="breed"
                  value={breed}
                  onChange={(e) => { setBreed(e.target.value); }}
                  placeholder={`e.g., ${String(petType === 'dog' ? 'Golden Retriever' : petType === 'cat' ? 'Maine Coon' : petType === 'bird' ? 'Parakeet' : petType === 'rabbit' ? 'Holland Lop' : petType === 'fish' ? 'Betta' : 'Mixed' ?? '')}`}
                  className="mt-1"
                />
              </div>
              <div>
                <Label htmlFor="age">Age (in years) *</Label>
                <Input
                  id="age"
                  type="number"
                  min="0"
                  max="30"
                  value={age}
                  onChange={(e) => { setAge(e.target.value); }}
                  placeholder="3"
                  className="mt-1"
                />
              </div>
            </div>
          </MotionView>
        );

      case 'characteristics':
        return (
          <MotionView key="characteristics" className="space-y-6">
            <div className="text-center mb-6">
              <h3 className="text-2xl font-bold mb-2">Physical characteristics</h3>
              <p className="text-muted-foreground">
                Help others know more about {name || 'your pet'}
              </p>
            </div>
            <div className="space-y-6">
              <div>
                <Label className="mb-3 block">Gender *</Label>
                <div className="grid grid-cols-2 gap-4">
                  <MotionView>
                    <Button
                      type="button"
                      variant={gender === 'male' ? 'default' : 'outline'}
                      className="w-full h-16 text-lg"
                      onClick={() => { setGender('male'); }}
                    >
                      ‚ôÇ Male
                    </Button>
                  </MotionView>
                  <MotionView>
                    <Button
                      type="button"
                      variant={gender === 'female' ? 'default' : 'outline'}
                      className="w-full h-16 text-lg"
                      onClick={() => { setGender('female'); }}
                    >
                      ‚ôÄ Female
                    </Button>
                  </MotionView>
                </div>
              </div>
              <div>
                <Label htmlFor="size" className="mb-3 block">
                  Size *
                </Label>
                <select
                  id="size"
                  value={size}
                  onChange={(e) => {
                    const value = e.target.value as 'small' | 'medium' | 'large' | 'extra-large';
                    if (['small', 'medium', 'large', 'extra-large'].includes(value)) {
                      setSize(value);
                    }
                  }}
                  className="w-full px-4 py-3 border border-input rounded-lg bg-background hover:border-ring transition-colors text-lg"
                >
                  <option value="small">Small</option>
                  <option value="medium">Medium</option>
                  <option value="large">Large</option>
                  <option value="extra-large">Extra Large</option>
                </select>
              </div>
              <div>
                <Label htmlFor="location">Location *</Label>
                <Input
                  id="location"
                  value={location}
                  onChange={(e) => { setLocation(e.target.value); }}
                  placeholder="e.g., San Francisco, CA"
                  className="mt-1"
                />
              </div>
            </div>
          </MotionView>
        );

      case 'photo':
        return (
          <MotionView key="photo" className="space-y-6">
            <div className="text-center mb-6">
              <h3 className="text-2xl font-bold mb-2">Add a photo of {name || 'your pet'}</h3>
              <p className="text-muted-foreground">
                A great photo helps others connect with your companion
              </p>
            </div>
            <Suspense
              fallback={
                <div className="flex items-center justify-center py-12">
                  <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                </div>
              }
            >
              <PetPhotoAnalyzer
                onAnalysisComplete={(result) => {
                  setPhoto(result.photo);
                  if (!breed) setBreed(result.breed);
                  if (!age) setAge(result.age.toString());
                  setSize(result.size);
                  setPersonality(result.personality);
                }}
              />
            </Suspense>
            <div>
              <Label htmlFor="photo">Photo URL *</Label>
              <Input
                id="photo"
                value={photo}
                onChange={(e) => { setPhoto(e.target.value); }}
                placeholder="https://images.unsplash.com/photo-..."
                className="mt-1"
              />
              {photoPresence.shouldRender && photo && (
                <MotionView
                  animatedStyle={photoPresence.animatedStyle}
                  className="mt-4 relative h-64 rounded-xl overflow-hidden bg-muted shadow-lg"
                >
                  <ProgressiveImage
                    src={photo}
                    alt="Preview"
                    className="w-full h-full object-cover"
                    aria-label="Pet photo preview"
                  />
                </MotionView>
              )}
            </div>
            <div>
              <Label htmlFor="bio">Bio (optional)</Label>
              <Textarea
                id="bio"
                value={bio}
                onChange={(e) => { setBio(e.target.value); }}
                placeholder={`Tell us what makes ${String((name || 'your pet') ?? '')} special...`}
                rows={3}
                className="mt-1"
              />
            </div>
          </MotionView>
        );

      case 'personality':
        return (
          <MotionView key="personality" className="space-y-6">
            <div className="text-center mb-6">
              <h3 className="text-2xl font-bold mb-2">
                What's {name || 'your pet'}'s personality?
              </h3>
              <p className="text-muted-foreground">Select all traits that apply</p>
            </div>
            <div className="flex flex-wrap gap-3 justify-center">
              {PERSONALITY_TRAITS[petType].map((trait) => (
                <Badge
                  key={trait}
                  variant={personality.includes(trait) ? 'default' : 'outline'}
                  className="cursor-pointer px-4 py-2 text-base"
                  onClick={() => toggleArrayItem(personality, trait, setPersonality)}
                >
                  {trait}
                  {personality.includes(trait) && (
                    <span>
                      <X size={14} className="ml-2" weight="bold" />
                    </span>
                  )}
                </Badge>
              ))}
            </div>
          </MotionView>
        );

      case 'preferences':
        return (
          <MotionView key="preferences" className="space-y-8">
            <div className="text-center mb-6">
              <h3 className="text-2xl font-bold mb-2">What does {name || 'your pet'} enjoy?</h3>
              <p className="text-muted-foreground">This helps us find perfect companions</p>
            </div>
            <div className="space-y-6">
              <div>
                <Label className="text-lg mb-3 block">Interests</Label>
                <div className="flex flex-wrap gap-2">
                  {INTERESTS[petType].map((interest) => (
                    <Badge
                      key={interest}
                      variant={interests.includes(interest) ? 'default' : 'outline'}
                      className="cursor-pointer px-3 py-1.5"
                      onClick={() => toggleArrayItem(interests, interest, setInterests)}
                    >
                      {interest}
                      {interests.includes(interest) && (
                        <X size={12} className="ml-1.5" weight="bold" />
                      )}
                    </Badge>
                  ))}
                </div>
              </div>
              <div>
                <Label className="text-lg mb-3 block">Looking For</Label>
                <div className="flex flex-wrap gap-2">
                  {LOOKING_FOR[petType].map((item) => (
                    <Badge
                      key={item}
                      variant={lookingFor.includes(item) ? 'default' : 'outline'}
                      className="cursor-pointer px-3 py-1.5"
                      onClick={() => toggleArrayItem(lookingFor, item, setLookingFor)}
                    >
                      {item}
                      {lookingFor.includes(item) && (
                        <X size={12} className="ml-1.5" weight="bold" />
                      )}
                    </Badge>
                  ))}
                </div>
              </div>
            </div>
          </MotionView>
        );

      case 'complete':
        return (
          <MotionView key="complete" className="space-y-6 text-center">
            <MotionView className="text-8xl mb-4">üéâ</MotionView>
            <h3 className="text-3xl font-bold">All set!</h3>
            <p className="text-lg text-muted-foreground">
              {name || 'Your pet'}'s profile is ready to go. Let's find some perfect companions!
            </p>
            <div className="bg-muted/50 rounded-2xl p-6 space-y-3 text-left max-w-md mx-auto">
              <div className="flex justify-between">
                <span className="text-muted-foreground">Name:</span>
                <span className="font-semibold">{name}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-muted-foreground">Type:</span>
                <span className="font-semibold capitalize">{petType}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-muted-foreground">Breed:</span>
                <span className="font-semibold">{breed}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-muted-foreground">Age:</span>
                <span className="font-semibold">
                  {age} {parseInt(age) === 1 ? 'year' : 'years'}
                </span>
              </div>
              <div className="flex justify-between">
                <span className="text-muted-foreground">Personality:</span>
                <span className="font-semibold">{personality.length} traits</span>
              </div>
            </div>
          </MotionView>
        );

      default:
        return null;
    }
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="text-xl flex items-center gap-2">
            <MotionView animatedStyle={emojiStyle}>üêæ</MotionView>
            {editingPet ? 'Edit Pet Profile' : 'Create Pet Profile'}
          </DialogTitle>
          <DialogDescription>
            {editingPet
              ? 'Update your pet\'s profile information'
              : 'Fill out the form to create a new pet profile'}
          </DialogDescription>
        </DialogHeader>

        <div className="w-full h-2 bg-muted rounded-full overflow-hidden mb-6">
          <MotionView
            className="h-full bg-linear-to-r from-primary to-accent"
            animatedStyle={progressStyle}
          />
        </div>

        {completeStepPresence.shouldRender && currentStep !== 'complete' && (
          <MotionView animatedStyle={completeStepPresence.animatedStyle}>
            {renderStepContent()}
          </MotionView>
        )}

        <div className="flex gap-3 pt-6 mt-6 border-t">
          {currentStep !== 'type' && currentStep !== 'complete' && (
            <MotionView>
              <Button type="button" variant="outline" onClick={handleBack} className="gap-2">
                <ArrowLeft size={16} weight="bold" />
                Back
              </Button>
            </MotionView>
          )}
          <div className="flex-1" />
          {currentStep !== 'complete' ? (
            <MotionView>
              <Button
                type="button"
                onClick={handleNext}
                disabled={!canProceed()}
                className="gap-2 bg-linear-to-r from-primary to-accent"
              >
                Continue
                <ArrowRight size={16} weight="bold" />
              </Button>
            </MotionView>
          ) : (
            <MotionView>
              <Button
                type="button"
                onClick={handleSubmit}
                className="gap-2 bg-linear-to-r from-primary to-accent"
              >
                <Check size={16} weight="bold" />
                {editingPet ? 'Save Changes' : 'Create Profile'}
              </Button>
            </MotionView>
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
}
