import { adoptionApi } from '@/api/adoption-api'
import { communityAPI } from '@/api/community-api'
import { lostFoundAPI } from '@/api/lost-found-api'
import { AdoptionCard } from '@/components/adoption/AdoptionCard'
import { AdoptionDetailDialog } from '@/components/adoption/AdoptionDetailDialog'
import { PostCard } from '@/components/community/PostCard'
import { PostComposer } from '@/components/community/PostComposer'
import { RankingSkeleton } from '@/components/community/RankingSkeleton'
import { CreateLostAlertDialog } from '@/components/lost-found/CreateLostAlertDialog'
import LostFoundMap from '@/components/maps/LostFoundMap'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { Skeleton } from '@/components/ui/skeleton'
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs'
import { useApp } from '@/contexts/AppContext'
import { filterPostsByFollows } from '@/core/services/follow-graph'
import { useStorage } from '@/hooks/useStorage'
import type { AdoptionProfile } from '@/lib/adoption-types'
import type { Post, PostFilters } from '@/lib/community-types'
import { haptics } from '@/lib/haptics'
import { createLogger } from '@/lib/logger'
import type { LostAlert } from '@/lib/lost-found-types'
import type { LostPetAlert } from '@/lib/maps/types'
import { ArrowsClockwise, Fire, Heart, MapPin, PawPrint, Plus, Sparkle, TrendUp } from '@phosphor-icons/react'
import { useSharedValue, useAnimatedStyle, withSpring, withTiming, interpolate, Extrapolation, withRepeat, withSequence } from 'react-native-reanimated'
import { AnimatedView } from '@/effects/reanimated/animated-view'
import type { AnimatedStyle } from '@/effects/reanimated/animated-view'
import { springConfigs, timingConfigs } from '@/effects/reanimated/transitions'
import { usePageTransition } from '@/effects/reanimated/use-page-transition'
import { useHoverLift } from '@/effects/reanimated/use-hover-lift'
import { useCallback, useEffect, useRef, useState } from 'react'
import { toast } from 'sonner'

const logger = createLogger('CommunityView')

function convertLostAlertToLostPetAlert(alert: LostAlert): LostPetAlert {
  return {
    id: alert.id,
    petId: alert.id,
    petName: alert.petSummary.name ?? 'Unknown',
    petPhoto: alert.photos[0] ?? '',
    breed: alert.petSummary.breed ?? 'Unknown',
    lastSeen: {
      lat: alert.lastSeen.lat ?? 0,
      lng: alert.lastSeen.lon ?? 0
    },
    lastSeenTime: new Date(alert.createdAt),
    description: alert.description ?? '',
    contactInfo: alert.contactMask ?? '',
    radius: 10, // Default radius
    status: alert.status === 'active' ? 'active' : alert.status === 'found' ? 'found' : 'expired',
    sightings: [],
    createdBy: alert.ownerId,
    createdAt: new Date(alert.createdAt)
  }
}


export default function CommunityView(): JSX.Element {
  const { t } = useApp()
  const [activeTab, setActiveTab] = useState<'feed' | 'adoption' | 'lost-found'>('feed')
  const [feedTab, setFeedTab] = useState<'for-you' | 'following'>('for-you')
  const [posts, setPosts] = useState<Post[]>([])
  const [loading, setLoading] = useState(true)
  const [hasMore, setHasMore] = useState(true)
  const [cursor, setCursor] = useState<string | undefined>()
  const [showComposer, setShowComposer] = useState(false)
  const [trendingTags, setTrendingTags] = useState<string[]>([])
  const loadingRef = useRef(false)
  const observerTarget = useRef<HTMLDivElement>(null)
  const containerRef = useRef<HTMLDivElement>(null)
  const startY = useRef<number>(0)
  const isPulling = useRef<boolean>(false)
  
  const [isRefreshing, setIsRefreshing] = useState(false)
  const pullDistance = useSharedValue(0)
  
  const pullOpacityStyle = useAnimatedStyle(() => {
    return {
      opacity: interpolate(
        pullDistance.value,
        [0, 80],
        [0, 1],
        Extrapolation.CLAMP
      )
    }
  }) as AnimatedStyle
  
  const pullRotationStyle = useAnimatedStyle(() => {
    return {
      transform: [{
        rotate: `${interpolate(
          pullDistance.value,
          [0, 80],
          [0, 360],
          Extrapolation.CLAMP
        )}deg`
      }]
    }
  }) as AnimatedStyle
  
  const pullScaleStyle = useAnimatedStyle(() => {
    return {
      transform: [{
        scale: interpolate(
          pullDistance.value,
          [0, 80],
          [0.5, 1],
          Extrapolation.CLAMP
        )
      }]
    }
  }) as AnimatedStyle
  
  const pullTranslateStyle = useAnimatedStyle(() => {
    return {
      transform: [{ translateY: pullDistance.value }]
    }
  }) as AnimatedStyle
  
  const mainTabsOpacity = useSharedValue(0)
  const mainTabsTranslateY = useSharedValue(20)
  
  useEffect(() => {
    mainTabsOpacity.value = withTiming(1, timingConfigs.smooth)
    mainTabsTranslateY.value = withTiming(0, timingConfigs.smooth)
  }, [mainTabsOpacity, mainTabsTranslateY])
  
  const mainTabsStyle = useAnimatedStyle(() => {
    return {
      opacity: mainTabsOpacity.value,
      transform: [{ translateY: mainTabsTranslateY.value }]
    }
  }) as AnimatedStyle
  
  const [adoptionProfiles, setAdoptionProfiles] = useState<AdoptionProfile[]>([])
  const [adoptionLoading, setAdoptionLoading] = useState(true)
  const [adoptionHasMore, setAdoptionHasMore] = useState(true)
  const [_adoptionCursor, setAdoptionCursor] = useState<string | undefined>()
  const [selectedAdoptionProfile, setSelectedAdoptionProfile] = useState<AdoptionProfile | null>(null)                                                          
  const [favoritedProfiles, setFavoritedProfiles] = useStorage<string[]>('favorited-adoption-profiles', [])
  const adoptionLoadingRef = useRef(false)
  const adoptionObserverTarget = useRef<HTMLDivElement>(null)

  const [lostFoundAlerts, setLostFoundAlerts] = useState<LostPetAlert[]>([])
  const [lostFoundLoading, setLostFoundLoading] = useState(false)
  const [showLostAlertDialog, setShowLostAlertDialog] = useState(false)

  const loadLostFoundAlerts = useCallback(async () => {
    if (activeTab !== 'lost-found' || lostFoundLoading) return
    
    setLostFoundLoading(true)
    try {
      const result = await lostFoundAPI.queryAlerts({ status: ['active'] })
      setLostFoundAlerts(result.alerts.map(convertLostAlertToLostPetAlert))
    } catch (error) {
      const err = error instanceof Error ? error : new Error(String(error))
      logger.error('Failed to load lost found alerts', err)
    } finally {
      setLostFoundLoading(false)
    }
  }, [activeTab, lostFoundLoading])

  useEffect(() => {
    void loadLostFoundAlerts();
  }, [loadLostFoundAlerts]);

  const loadFeed = useCallback(async (loadMore = false) => {
    if (loadingRef.current) return
    
    try {
      loadingRef.current = true
      setLoading(true)
      
      const { userService } = await import('@/lib/user-service')
      const user = await userService.user()
      const filters: PostFilters & { limit?: number; cursor?: string } = {
        limit: 20,
        ...(loadMore && cursor ? { cursor } : {})
      }

      const response = await communityAPI.queryFeed(filters, user?.id)
      
      // Filter posts by follow relationships if "following" tab is selected
      let filteredPosts = response.posts
      if (feedTab === 'following') {
        if (user) {
          filteredPosts = await filterPostsByFollows<Post>(response.posts, user.id)
        }
      }
      
      if (loadMore) {
        setPosts((currentPosts) => [...(Array.isArray(currentPosts) ? currentPosts : []), ...filteredPosts])
      } else {
        setPosts(filteredPosts)
      }
      
      setHasMore(!!response.nextCursor)
      setCursor(response.nextCursor)
    } catch (error) {
      const err = error instanceof Error ? error : new Error(String(error))
      logger.error('Failed to load feed', err, { action: 'loadFeed', feedTab })
    } finally {
      setLoading(false)
      loadingRef.current = false
    }
  }, [feedTab, cursor])

  const loadAdoptionProfiles = useCallback(async (loadMore = false) => {
    if (adoptionLoadingRef.current) return
    
    try {
      adoptionLoadingRef.current = true
      setAdoptionLoading(true)
      
      const response = await adoptionApi.getAdoptionProfiles({ limit: 12 })
      
      if (loadMore) {
        setAdoptionProfiles((currentProfiles) => [...(Array.isArray(currentProfiles) ? currentProfiles : []), ...(Array.isArray(response.profiles) ? response.profiles.map((l: AdoptionProfile): AdoptionProfile => ({
          _id: l._id,
          petId: l.petId,
          petName: l.petName,
          petPhoto: l.petPhoto,
          breed: l.breed,
          age: l.age,
          gender: l.gender,
          size: l.size,
          location: l.location,
          shelterId: l.shelterId,
          shelterName: l.shelterName,
          status: l.status,
          description: l.description,
          healthStatus: l.healthStatus,
          vaccinated: l.vaccinated,
          spayedNeutered: l.spayedNeutered,
          goodWithKids: l.goodWithKids,
          goodWithPets: l.goodWithPets,
          energyLevel: l.energyLevel,
          ...(l.specialNeeds && { specialNeeds: l.specialNeeds }),
          adoptionFee: l.adoptionFee,
          postedDate: l.postedDate,
          personality: l.personality,
          photos: l.photos,
          ...(l.videoUrl && { videoUrl: l.videoUrl }),
          contactEmail: l.contactEmail,
          ...(l.contactPhone && { contactPhone: l.contactPhone }),
          ...(l.applicationUrl && { applicationUrl: l.applicationUrl })
        })) : [])])
      } else {
        setAdoptionProfiles(Array.isArray(response.profiles) ? response.profiles.map((l: AdoptionProfile): AdoptionProfile => ({
          _id: l._id,
          petId: l.petId,
          petName: l.petName,
          petPhoto: l.petPhoto,
          breed: l.breed,
          age: l.age,
          gender: l.gender,
          size: l.size,
          location: l.location,
          shelterId: l.shelterId,
          shelterName: l.shelterName,
          status: l.status,
          description: l.description,
          healthStatus: l.healthStatus,
          vaccinated: l.vaccinated,
          spayedNeutered: l.spayedNeutered,
          goodWithKids: l.goodWithKids,
          goodWithPets: l.goodWithPets,
          energyLevel: l.energyLevel,
          ...(l.specialNeeds && { specialNeeds: l.specialNeeds }),
          adoptionFee: l.adoptionFee,
          postedDate: l.postedDate,
          personality: l.personality,
          photos: l.photos,
          ...(l.videoUrl && { videoUrl: l.videoUrl }),
          contactEmail: l.contactEmail,
          ...(l.contactPhone && { contactPhone: l.contactPhone }),
          ...(l.applicationUrl && { applicationUrl: l.applicationUrl })
        })) : [])
      }
      
      setAdoptionHasMore(!!response.nextCursor)
      setAdoptionCursor(response.nextCursor)
    } catch (error) {
      const err = error instanceof Error ? error : new Error(String(error))
      logger.error('Failed to load adoption profiles', err, { action: 'loadAdoptionProfiles' })
    } finally {
      setAdoptionLoading(false)
      adoptionLoadingRef.current = false
    }
  }, [])

  const loadTrendingTags = useCallback(async () => {
    try {
      const { userService } = await import('@/lib/user-service')
      const user = await userService.user()
      const response = await communityAPI.queryFeed({ limit: 100 }, user?.id)
      const allTags: string[] = []
      
      if (Array.isArray(response.posts)) {
        response.posts.forEach((post: Post) => {
          if (post.tags && Array.isArray(post.tags)) {
            allTags.push(...post.tags)
          }
        })
      }
      
      // Count tag frequency
      const tagCounts = allTags.reduce((acc, tag) => {
        acc[tag] = (acc[tag] ?? 0) + 1
        return acc
      }, {} as Record<string, number>)
      
      // Sort by frequency and take top 10
      const sortedTags = Object.entries(tagCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([tag]) => tag)
      
      setTrendingTags(sortedTags)
    } catch (error) {
      const err = error instanceof Error ? error : new Error(String(error))
      logger.error('Failed to load trending tags', err, { action: 'loadTrendingTags' })                                                                         
      setTrendingTags([])
    }
  }, [])

  const handleTouchStart = useCallback((e: TouchEvent) => {
    const container = containerRef.current
    if (container?.scrollTop === 0 && activeTab === 'feed' && e.touches?.[0]) {
      startY.current = e.touches[0].clientY
      isPulling.current = true
    }
  }, [activeTab])

  const handleTouchMove = useCallback((e: TouchEvent) => {
    const container = containerRef.current
    if (!isPulling.current || !container || !e.touches?.[0]) return

    const currentY = e.touches[0].clientY
    const diff = currentY - startY.current

    if (diff > 0 && diff < 120) {
      pullDistance.value = diff
    }
  }, [pullDistance])

  const handleTouchEnd = useCallback(async () => {
    if (!isPulling.current) return
    isPulling.current = false

    const distance = pullDistance.value
    
    if (distance > 80) {
      setIsRefreshing(true)
      haptics.impact('light')
      
      try {
        await loadFeed()
        await loadTrendingTags()
        haptics.success()
        toast.success(t.community?.refreshed ?? 'Feed refreshed!')
      } catch (error) {
        const err = error instanceof Error ? error : new Error(String(error))
        logger.error('Failed to refresh feed', err)
        haptics.error()
        toast.error(t.community?.refreshError ?? 'Failed to refresh')
      } finally {
        setIsRefreshing(false)
      }
    }

    pullDistance.value = withSpring(0, springConfigs.smooth)
  }, [pullDistance, t, loadFeed, loadTrendingTags])

  useEffect(() => {
    const container = containerRef.current
    if (!container || activeTab !== 'feed') return

    const touchStartHandler = (e: TouchEvent) => handleTouchStart(e)
    const touchMoveHandler = (e: TouchEvent) => handleTouchMove(e)
    const touchEndHandler = () => {
      void handleTouchEnd()
    }

    container.addEventListener('touchstart', touchStartHandler, { passive: true })                                                                               
    container.addEventListener('touchmove', touchMoveHandler, { passive: true })
    container.addEventListener('touchend', touchEndHandler, { passive: true })

    return () => {
      container.removeEventListener('touchstart', touchStartHandler)
      container.removeEventListener('touchmove', touchMoveHandler)
      container.removeEventListener('touchend', touchEndHandler)
    }
  }, [handleTouchStart, handleTouchMove, handleTouchEnd, activeTab])

  useEffect(() => {
    if (activeTab === 'feed') {
      void loadFeed()
      void loadTrendingTags()
    } else if (activeTab === 'adoption') {
      void loadAdoptionProfiles()
    }
  }, [activeTab, feedTab, loadFeed, loadTrendingTags, loadAdoptionProfiles])

  useEffect(() => {
    const observer = new IntersectionObserver(
      (entries) => {
        const entry = entries[0]
        if (entry?.isIntersecting && hasMore && !loading && !loadingRef.current && activeTab === 'feed') {                                                      
          void loadFeed(true)
        }
      },
      { threshold: 0.1 }
    )

    if (observerTarget.current) {
      observer.observe(observerTarget.current)
    }

    return () => observer.disconnect()
  }, [hasMore, loading, activeTab, loadFeed])

  useEffect(() => {
    const observer = new IntersectionObserver(
      (entries) => {
        const entry = entries[0]
        if (entry?.isIntersecting && adoptionHasMore && !adoptionLoading && !adoptionLoadingRef.current && activeTab === 'adoption') {                          
          void loadAdoptionProfiles(true)
        }
      },
      { threshold: 0.1 }
    )

    if (adoptionObserverTarget.current) {
      observer.observe(adoptionObserverTarget.current)
    }

    return () => observer.disconnect()
  }, [adoptionHasMore, adoptionLoading, activeTab, loadAdoptionProfiles])

  const handleAuthorClick = (authorId: string): void => {
    logger.info('View author profile', { action: 'viewAuthorProfile', authorId })
  }

  const handlePostCreated = useCallback(() => {
    void loadFeed()
    void loadTrendingTags()
  }, [loadFeed, loadTrendingTags])

  const handleMainTabChange = (value: string) => {
    setActiveTab(value as 'feed' | 'adoption')
    haptics.selection()
  }

  const handleFeedTabChange = (value: string) => {
    setFeedTab(value as 'for-you' | 'following')
    setPosts([])
    setCursor(undefined)
    setHasMore(true)
    haptics.selection()
  }

  const handleCreatePost = () => {
    setShowComposer(true)
    haptics.impact()
  }

  const handleToggleFavorite = (profileId: string) => {
    setFavoritedProfiles((currentFavorites) => {
      const current = Array.isArray(currentFavorites) ? currentFavorites : []
      const isFavorited = current.includes(profileId)
      if (isFavorited) {
        return current.filter(id => id !== profileId)
      } else {
        return [...current, profileId]
      }
    })
    haptics.trigger('light')
  }

  // Animation hooks
  const headerTransition = usePageTransition({ isVisible: true, direction: 'down', duration: 300 })
  const trendingTransition = usePageTransition({ isVisible: trendingTags.length > 0, direction: 'up', duration: 300 })
  const refreshButtonHover = useHoverLift({ scale: 1.05 })
  const createButtonHover = useHoverLift({ scale: 1.05 })
  const emptyStateTransition = usePageTransition({ isVisible: posts.length === 0 && !loading, direction: 'fade', duration: 500 })
  
  // Empty state animation
  const emptyScale = useSharedValue(1)
  const emptyRotation = useSharedValue(0)
  const loadingRotation = useSharedValue(0)
  
  useEffect(() => {
    if (posts.length === 0 && !loading) {
      emptyScale.value = withRepeat(
        withSequence(
          withTiming(1.1, { duration: 1000 }),
          withTiming(1, { duration: 1000 })
        ),
        -1,
        true
      )
      emptyRotation.value = withRepeat(
        withSequence(
          withTiming(5, { duration: 500 }),
          withTiming(-5, { duration: 500 }),
          withTiming(0, { duration: 500 })
        ),
        -1,
        false
      )
    }
  }, [posts.length, loading, emptyScale, emptyRotation])
  
  useEffect(() => {
    if (loading || adoptionLoading) {
      loadingRotation.value = withRepeat(
        withTiming(360, { duration: 1000 }),
        -1,
        false
      )
    } else {
      loadingRotation.value = 0
    }
  }, [loading, adoptionLoading, loadingRotation])
  
  const loadingSpinnerStyle = useAnimatedStyle(() => ({
    transform: [{ rotate: `${loadingRotation.value}deg` }],
  })) as AnimatedStyle
  
  const emptyStateStyle = useAnimatedStyle(() => ({
    transform: [
      { scale: emptyScale.value },
      { rotate: `${emptyRotation.value}deg` }
    ]
  })) as AnimatedStyle
  
  // Adoption skeleton animation
  const adoptionSkeletonOpacity = useSharedValue(0)
  const adoptionSkeletonTranslateY = useSharedValue(20)
  
  useEffect(() => {
    if (adoptionLoading && adoptionProfiles.length === 0) {
      adoptionSkeletonOpacity.value = withTiming(1, timingConfigs.smooth)
      adoptionSkeletonTranslateY.value = withTiming(0, timingConfigs.smooth)
    }
  }, [adoptionLoading, adoptionProfiles.length, adoptionSkeletonOpacity, adoptionSkeletonTranslateY])
  
  
  // Adoption empty state animation
  const adoptionEmptyScale = useSharedValue(1)
  const adoptionEmptyRotation = useSharedValue(0)
  
  useEffect(() => {
    if (adoptionProfiles.length === 0 && !adoptionLoading) {
      adoptionEmptyScale.value = withRepeat(
        withSequence(
          withTiming(1.1, { duration: 1000 }),
          withTiming(1, { duration: 1000 })
        ),
        -1,
        true
      )
      adoptionEmptyRotation.value = withRepeat(
        withSequence(
          withTiming(5, { duration: 500 }),
          withTiming(-5, { duration: 500 }),
          withTiming(0, { duration: 500 })
        ),
        -1,
        false
      )
    }
  }, [adoptionProfiles.length, adoptionLoading, adoptionEmptyScale, adoptionEmptyRotation])
  
  
  // Adoption profile card entry animation
  const adoptionCardOpacity = useSharedValue(0)
  const adoptionCardTranslateY = useSharedValue(20)
  
  useEffect(() => {
    if (adoptionProfiles.length > 0) {
      adoptionCardOpacity.value = withTiming(1, timingConfigs.smooth)
      adoptionCardTranslateY.value = withTiming(0, timingConfigs.smooth)
    }
  }, [adoptionProfiles.length, adoptionCardOpacity, adoptionCardTranslateY])
  
  
  // Adoption loading spinner
  const adoptionLoadingRotation = useSharedValue(0)
  
  useEffect(() => {
    if (adoptionLoading) {
      adoptionLoadingRotation.value = withRepeat(
        withTiming(360, { duration: 1000 }),
        -1,
        false
      )
    } else {
      adoptionLoadingRotation.value = 0
    }
  }, [adoptionLoading, adoptionLoadingRotation])
  
  const adoptionLoadingSpinnerStyle = useAnimatedStyle(() => ({
    transform: [{ rotate: `${adoptionLoadingRotation.value}deg` }],
  })) as AnimatedStyle

  return (
    <div ref={containerRef} className="max-w-6xl mx-auto space-y-6 pb-8 relative">
      {/* Pull-to-Refresh Indicator */}
      <AnimatedView
        className="absolute top-0 left-1/2 -translate-x-1/2 z-50 pointer-events-none"
        style={[pullTranslateStyle, pullOpacityStyle]}
      >
        <AnimatedView
          className="bg-card/95 backdrop-blur-xl shadow-xl rounded-full p-3 border border-border/50"
          style={[pullRotationStyle, pullScaleStyle]}
        >
          <ArrowsClockwise 
            size={24} 
            weight="bold" 
            className={`${isRefreshing ? 'animate-spin' : ''} text-primary`}
          />
        </AnimatedView>
      </AnimatedView>

      {/* Header */}
      <AnimatedView style={headerTransition.style} className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold bg-linear-to-r from-primary via-accent to-secondary bg-clip-text text-transparent">
            {t.community?.title ?? 'Community'}
          </h1>
          <p className="text-sm text-muted-foreground mt-1">
            {activeTab === 'feed' 
              ? (t.community?.feed ?? 'Share and discover pet moments')
              : (t.adoption?.subtitle ?? 'Find your perfect companion')}
          </p>
        </div>
        <div className="flex items-center gap-2">
          {activeTab === 'feed' && (
            <>
              <AnimatedView
                style={refreshButtonHover.animatedStyle}
                onMouseEnter={refreshButtonHover.handleEnter}
                onMouseLeave={refreshButtonHover.handleLeave}
              >
                <Button 
                  variant="outline" 
                  size="icon"
                  onClick={() => {
                    void (async () => {
                      setIsRefreshing(true)
                      haptics.impact()
                      try {
                        await loadFeed()
                        await loadTrendingTags()
                        haptics.success()
                        toast.success(t.community?.refreshed ?? 'Feed refreshed!')
                      } catch (error) {
                        const err = error instanceof Error ? error : new Error(String(error))
                        logger.error('Failed to refresh feed', err)
                        haptics.error()
                        toast.error(t.community?.refreshError ?? 'Failed to refresh')
                      } finally {
                        setIsRefreshing(false)
                      }
                    })()
                  }}
                  disabled={isRefreshing}
                  className="shadow-md"
                >
                  <ArrowsClockwise 
                    size={20} 
                    weight="bold" 
                    className={isRefreshing ? 'animate-spin' : ''}
                  />
                </Button>
              </AnimatedView>
              <AnimatedView
                style={createButtonHover.animatedStyle}
                onMouseEnter={createButtonHover.handleEnter}
                onMouseLeave={createButtonHover.handleLeave}
              >
                <Button size="lg" className="gap-2 shadow-lg" onClick={handleCreatePost}>
                  <Plus size={20} weight="bold" />
                    <span className="hidden sm:inline">{t.community?.createPost ?? 'Create Post'}</span>
                    <span className="sm:hidden">{t.community?.post ?? 'Post'}</span>
                </Button>
              </AnimatedView>
            </>
          )}
        </div>
      </AnimatedView>

      {/* Main Tabs - Feed & Adoption */}
      <AnimatedView style={mainTabsStyle}>
        <Tabs value={activeTab} onValueChange={handleMainTabChange}>
          <TabsList className="grid w-full grid-cols-3 bg-card shadow-md">
            <TabsTrigger value="feed" className="gap-2">
              <Fire size={18} weight={activeTab === 'feed' ? 'fill' : 'regular'} />                                                                             
              {t.community?.feed ?? 'Feed'}
            </TabsTrigger>
            <TabsTrigger value="adoption" className="gap-2">
              <Heart size={18} weight={activeTab === 'adoption' ? 'fill' : 'regular'} />                                                                        
              {t.adoption?.title ?? 'Adoption'}
            </TabsTrigger>
            <TabsTrigger value="lost-found" className="gap-2">
              <MapPin size={18} weight={activeTab === 'lost-found' ? 'fill' : 'regular'} />                                                                        
              {t.map?.lostAndFound ?? 'Lost & Found'}
            </TabsTrigger>
          </TabsList>

          {/* Feed Tab Content */}
          <TabsContent value="feed" className="mt-6 space-y-6">
            {/* Trending Tags */}
            {trendingTags.length > 0 && (
              <AnimatedView
                style={trendingTransition.style}
                className="bg-linear-to-br from-card via-card to-card/50 rounded-xl p-4 border border-border/50 shadow-lg"
              >
                <div className="flex items-center gap-2 mb-3">
                  <TrendUp size={20} className="text-accent" weight="bold" />
                  <h3 className="font-semibold text-foreground">
                    {t.community?.trending ?? 'Trending Today'}
                  </h3>
                  <Fire size={16} className="text-destructive ml-auto" weight="fill" />
                </div>
                <div className="flex flex-wrap gap-2">
                  {trendingTags.map(tag => (
                    <Badge
                      key={tag}
                      variant="secondary"
                      className="cursor-pointer hover:bg-primary/20 transition-colors"
                      onClick={() => haptics.selection()}
                    >
                      #{tag}
                    </Badge>
                  ))}
                </div>
              </AnimatedView>
            )}

            {/* Feed Sub-Tabs */}
            <Tabs value={feedTab} onValueChange={handleFeedTabChange}>
              <TabsList className="grid w-full grid-cols-2 bg-card shadow-md max-w-md mx-auto">
                <TabsTrigger value="for-you" className="gap-2">
                  <Sparkle size={18} weight={feedTab === 'for-you' ? 'fill' : 'regular'} />
                  {t.community?.forYou ?? 'For You'}
                </TabsTrigger>
                <TabsTrigger value="following" className="gap-2">
                  <Fire size={18} weight={feedTab === 'following' ? 'fill' : 'regular'} />
                  {t.community?.following ?? 'Following'}
                </TabsTrigger>
              </TabsList>

              <TabsContent value={feedTab} className="mt-6 space-y-4 max-w-3xl mx-auto">
            {loading && posts.length === 0 ? (
              <RankingSkeleton count={3} variant="post" />
            ) : posts.length === 0 ? (
              <AnimatedView
                style={emptyStateTransition.style}
                className="text-center py-20"
              >
                <AnimatedView
                  style={emptyStateStyle}
                  className="text-8xl mb-6"
                >
                  üêæ
                </AnimatedView>
                  <h3 className="text-2xl font-bold text-foreground mb-2">
                    {t.community?.noPosts ?? 'No posts yet'}
                  </h3>
                  <p className="text-muted-foreground mb-8 max-w-md mx-auto">
                    {feedTab === 'following'
                      ? (t.community?.noFollowingPosts ?? 'Follow some pets to see their posts here!')
                      : (t.community?.noPostsDesc ?? 'Be the first to share something amazing!')}
                  </p>
                  <AnimatedView
                    style={createButtonHover.animatedStyle}
                    onMouseEnter={createButtonHover.handleEnter}
                    onMouseLeave={createButtonHover.handleLeave}
                  >
                    <Button size="lg" className="gap-2 shadow-lg" onClick={handleCreatePost}>
                      <Plus size={20} weight="bold" />
                      {t.community?.createPost ?? 'Create Post'}
                    </Button>
                  </AnimatedView>
              </AnimatedView>
            ) : (
              <>
                {posts.map((post) => (
                  <PostCard
                    key={post.id}
                    post={post}
                    onAuthorClick={handleAuthorClick}
                  />
                ))}

                {/* Infinite scroll trigger */}
                <div ref={observerTarget} className="h-20 flex items-center justify-center">
                  {loading && (
                    <div className="flex items-center gap-2 text-muted-foreground">
                      <AnimatedView style={loadingSpinnerStyle}>
                        <Sparkle size={20} />
                      </AnimatedView>
                      <span className="text-sm">{t.common?.loading ?? 'Loading...'}</span>
                    </div>
                  )}
                  {!hasMore && posts.length > 0 && (
                    <div className="text-center text-muted-foreground text-sm py-8">
                      {t.community?.endOfFeed ?? "You're all caught up! üéâ"}
                    </div>
                  )}
                </div>
              </>
            )}
              </TabsContent>
            </Tabs>
          </TabsContent>

          {/* Adoption Tab Content */}
          <TabsContent value="adoption" className="mt-6 space-y-6">
            {adoptionLoading && adoptionProfiles.length === 0 ? (
              <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
                {[1, 2, 3, 4, 5, 6].map(i => (
                  <div
                    key={i}
                    className="bg-card rounded-xl overflow-hidden border border-border/50 shadow-md"                                                            
                  >
                    <Skeleton className="h-64 w-full" />
                    <div className="p-4 space-y-3">
                      <Skeleton className="h-6 w-32" />
                      <Skeleton className="h-4 w-full" />
                      <Skeleton className="h-4 w-4/5" />
                      <div className="flex gap-2">
                        <Skeleton className="h-6 w-20" />
                        <Skeleton className="h-6 w-20" />
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            ) : adoptionProfiles.length === 0 ? (
              <AnimatedView
                style={usePageTransition({ isVisible: true, direction: 'fade', duration: 500 }).style}
                className="text-center py-20"
              >
                <AnimatedView
                  style={emptyStateStyle}
                  className="text-8xl mb-6"
                >
                  üè†
                </AnimatedView>
                <h3 className="text-2xl font-bold text-foreground mb-2">
                  {t.adoption?.noProfiles ?? 'No pets available for adoption'}
                </h3>
                <p className="text-muted-foreground mb-8 max-w-md mx-auto">
                  {t.adoption?.noProfilesDesc ?? 'Check back soon for pets looking for their forever homes.'}
                </p>
              </AnimatedView>
            ) : (
              <>
                <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
                  {adoptionProfiles.map((profile) => (
                    <AdoptionCard
                      key={profile._id}
                      profile={profile}
                      onSelect={setSelectedAdoptionProfile}
                      onFavorite={handleToggleFavorite}
                      isFavorited={Array.isArray(favoritedProfiles) && favoritedProfiles.includes(profile._id)}
                    />
                  ))}
                </div>

                {/* Infinite scroll trigger for adoption */}
                <div ref={adoptionObserverTarget} className="h-20 flex items-center justify-center">
                  {adoptionLoading && (
                    <div className="flex items-center gap-2 text-muted-foreground">
                      <AnimatedView style={adoptionLoadingSpinnerStyle}>
                        <PawPrint size={20} />
                      </AnimatedView>
                      <span className="text-sm">{t.common?.loading ?? 'Loading...'}</span>
                    </div>
                  )}
                  {!adoptionHasMore && adoptionProfiles.length > 0 && (
                    <div className="text-center text-muted-foreground text-sm py-8">
                      {t.adoption?.endOfList ?? "You've seen all available pets! üêæ"}
                    </div>
                  )}
                </div>
              </>
            )}
          </TabsContent>

          <TabsContent value="lost-found" className="mt-6 space-y-6">
            <LostFoundMap
              alerts={lostFoundAlerts}
              onReportSighting={(alertId, location) => {
                void (async () => {
                  try {
                    const { userService } = await import('@/lib/user-service')
                    const currentUser = await userService.user()
                    if (!currentUser) {
                      toast.error('You must be logged in to report sightings')
                      return
                    }
                    await lostFoundAPI.createSighting({
                      alertId,
                      whenISO: new Date().toISOString(),
                      lat: location.lat,
                      lon: location.lng,
                      radiusM: 1000,
                      description: '',
                      photos: [],
                      contactMask: '',
                      reporterId: typeof currentUser.id === 'string' ? currentUser.id : '',                                                                       
                      reporterName: typeof currentUser['name'] === 'string' ? currentUser['name'] : 'Anonymous',                                                  
                      ...(currentUser.avatarUrl && { reporterAvatar: currentUser.avatarUrl }),                                                                    
                    })
                    toast.success(t.lostFound?.sightingSubmitted ?? 'Sighting reported')                                                                         
                  } catch (error) {
                    const err = error instanceof Error ? error : new Error(String(error))                                                                        
                    logger.error('Failed to report sighting', err)
                    toast.error('Failed to report sighting')
                  }
                })()
              }}
              onReportLost={() => {
                setShowLostAlertDialog(true)
                haptics.impact('light')
              }}
            />
          </TabsContent>
        </Tabs>
      </AnimatedView>
      <PostComposer
        open={showComposer}
        onOpenChange={setShowComposer}
        onPostCreated={handlePostCreated}
      />

      {/* Adoption Detail Dialog */}
      <AdoptionDetailDialog
        profile={selectedAdoptionProfile}
        open={!!selectedAdoptionProfile}
        onOpenChange={(open) => !open && setSelectedAdoptionProfile(null)}
      />

      {/* Lost Alert Dialog */}
      <CreateLostAlertDialog
        open={showLostAlertDialog}
        onClose={() => setShowLostAlertDialog(false)}
        onSuccess={() => {
          void loadLostFoundAlerts()
        }}
      />
    </div>
  )
}
