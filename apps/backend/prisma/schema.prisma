// Prisma Schema for PetSpark Backend
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================================
// Core User & Authentication
// ===================================

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String   @map("password_hash")
  emailVerified Boolean  @default(false) @map("email_verified")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  // Profile
  profile       UserProfile?
  pets          Pet[]
  refreshTokens RefreshToken[]
  
  @@map("users")
}

model UserProfile {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  firstName String?  @map("first_name")
  lastName  String?  @map("last_name")
  avatar    String?
  bio       String?
  location  Json?    // { lat, lng, city, state, country }
  preferences Json?  // User preferences
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("user_profiles")
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// ===================================
// Pets
// ===================================

model Pet {
  id          String   @id @default(uuid())
  ownerId     String   @map("owner_id")
  name        String
  species     String   // dog, cat, etc.
  breed       String?
  age         Int?
  gender      String?  // male, female, unknown
  size        String?  // small, medium, large
  description String?
  photos      Photo[]
  matches     Match[]  @relation("MatchedPets")
  blockedPets BlockedPet[] @relation("BlockerPet")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  @@index([ownerId])
  @@map("pets")
}

// ===================================
// Photos & Moderation
// ===================================

model Photo {
  id          String   @id @default(uuid())
  petId       String?  @map("pet_id")
  userId      String?  @map("user_id")
  url         String
  thumbnailUrl String? @map("thumbnail_url")
  status      String   @default("pending") // pending, approved, rejected
  moderationTask ModerationTask?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  pet Pet? @relation(fields: [petId], references: [id], onDelete: Cascade)
  
  @@index([petId])
  @@index([status])
  @@map("photos")
}

model ModerationTask {
  id        String   @id @default(uuid())
  photoId   String   @unique @map("photo_id")
  status    String   @default("pending") // pending, in_progress, completed
  assignedTo String? @map("assigned_to")
  result    String?  // approved, rejected
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  photo Photo @relation(fields: [photoId], references: [id], onDelete: Cascade)
  
  @@index([status])
  @@map("moderation_tasks")
}

// ===================================
// Matching
// ===================================

model Match {
  id        String   @id @default(uuid())
  pet1Id    String   @map("pet1_id")
  pet2Id    String   @map("pet2_id")
  score     Float
  status    String   @default("pending") // pending, matched, rejected
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  pet1 Pet @relation("MatchedPets", fields: [pet1Id], references: [id])
  pet2 Pet @relation("MatchedPets", fields: [pet2Id], references: [id])
  
  @@unique([pet1Id, pet2Id])
  @@index([pet1Id])
  @@index([pet2Id])
  @@map("matches")
}

// ===================================
// Chat & Messaging
// ===================================

model Conversation {
  id        String   @id @default(uuid())
  matchId   String?  @unique @map("match_id")
  userId1   String   @map("user_id1")
  userId2   String   @map("user_id2")
  lastMessageAt DateTime? @map("last_message_at")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  messages  Message[]
  
  @@index([userId1])
  @@index([userId2])
  @@map("conversations")
}

model Message {
  id             String   @id @default(uuid())
  conversationId String   @map("conversation_id")
  senderId       String   @map("sender_id")
  content        String
  read           Boolean  @default(false)
  readAt         DateTime? @map("read_at")
  createdAt      DateTime @default(now()) @map("created_at")
  
  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@index([conversationId])
  @@index([senderId])
  @@map("messages")
}

// ===================================
// Notifications
// ===================================

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String   // match, message, like, comment, etc.
  title     String
  body      String
  data      Json?    // Additional data
  read      Boolean  @default(false)
  readAt    DateTime? @map("read_at")
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@index([read])
  @@map("notifications")
}

// ===================================
// Adoption Marketplace
// ===================================

model AdoptionListing {
  id          String   @id @default(uuid())
  petId       String   @map("pet_id")
  ownerId     String   @map("owner_id")
  title       String
  description String
  location    Json     // { lat, lng, city, state, country }
  status      String   @default("active") // active, pending, adopted, closed
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  applications AdoptionApplication[]
  
  @@index([ownerId])
  @@index([status])
  @@map("adoption_listings")
}

model AdoptionApplication {
  id        String   @id @default(uuid())
  listingId String  @map("listing_id")
  applicantId String @map("applicant_id")
  message   String
  status    String   @default("pending") // pending, approved, rejected
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  listing AdoptionListing @relation(fields: [listingId], references: [id], onDelete: Cascade)
  
  @@index([listingId])
  @@index([applicantId])
  @@map("adoption_applications")
}

// ===================================
// Community
// ===================================

model CommunityPost {
  id        String   @id @default(uuid())
  authorId  String   @map("author_id")
  content   String
  photos    Json?    // Array of photo URLs
  likes     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  comments  CommunityComment[]
  
  @@index([authorId])
  @@index([createdAt])
  @@map("community_posts")
}

model CommunityComment {
  id        String   @id @default(uuid())
  postId    String   @map("post_id")
  authorId  String   @map("author_id")
  content   String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  post CommunityPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  @@index([postId])
  @@index([authorId])
  @@map("community_comments")
}

// ===================================
// Blocking
// ===================================

model BlockedPet {
  id           String   @id @default(uuid())
  blockerPetId String   @map("blocker_pet_id")
  blockedPetId String   @map("blocked_pet_id")
  createdAt    DateTime @default(now()) @map("created_at")
  
  blockerPet Pet @relation("BlockerPet", fields: [blockerPetId], references: [id], onDelete: Cascade)
  
  @@unique([blockerPetId, blockedPetId])
  @@index([blockerPetId])
  @@map("blocked_pets")
}

// ===================================
// Payments & Subscriptions
// ===================================

model Subscription {
  id            String   @id @default(uuid())
  userId        String   @map("user_id")
  stripeId      String?  @unique @map("stripe_id")
  status        String   // active, canceled, past_due
  plan          String
  currentPeriodEnd DateTime? @map("current_period_end")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  
  @@index([userId])
  @@map("subscriptions")
}

// ===================================
// KYC Verification
// ===================================

model KYCVerification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  status    String   @default("pending") // pending, approved, rejected
  documents Json?    // Document URLs
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@index([userId])
  @@index([status])
  @@map("kyc_verifications")
}

// ===================================
// Lost & Found
// ===================================

model LostFoundAlert {
  id        String   @id @default(uuid())
  petId     String?  @map("pet_id")
  ownerId   String   @map("owner_id")
  type      String   // lost, found
  location  Json     // { lat, lng, address }
  description String
  photos    Json?    // Array of photo URLs
  status    String   @default("active") // active, resolved, closed
  views     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@index([ownerId])
  @@index([status])
  @@index([type])
  @@map("lost_found_alerts")
}

// ===================================
// Live Streaming
// ===================================

model LiveStream {
  id        String   @id @default(uuid())
  hostId    String   @map("host_id")
  roomId    String   @unique @map("room_id")
  title     String?
  status    String   @default("active") // active, ended
  viewerCount Int    @default(0) @map("viewer_count")
  startedAt DateTime @default(now()) @map("started_at")
  endedAt   DateTime? @map("ended_at")
  
  @@index([hostId])
  @@index([status])
  @@map("live_streams")
}

// ===================================
// Audit Logs
// ===================================

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  action    String
  resource  String
  resourceId String? @map("resource_id")
  details   Json?
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

// ===================================
// User Quotas
// ===================================

model UserQuota {
  id        String   @id @default(uuid())
  userId    String   @unique @map("user_id")
  limits    Json     // { pets: number, photos: number, matches: number, messages: number }
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  
  @@index([userId])
  @@map("user_quotas")
}

// ===================================
// Events
// ===================================

model Event {
  id        String   @id @default(uuid())
  type      String
  data      Json?
  userId    String?  @map("user_id")
  petId     String?  @map("pet_id")
  createdAt DateTime @default(now()) @map("created_at")
  
  @@index([type])
  @@index([userId])
  @@index([petId])
  @@index([createdAt])
  @@map("events")
}

